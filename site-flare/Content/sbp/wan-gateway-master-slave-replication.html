<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
<head></head>
<body>
<h1>WAN Gateway Master Slave Replication</h1>
  

<table>
<thead>
<tr>
<th>Author</th>
<th>XAP Version</th>
<th>Last Updated</th>
<th>Reference</th>
<th>Download</th>
</tr>
</thead>

<tbody>
<tr>
<td>Ali Hodroj</td>
<td>9.6</td>
<td>July 2013</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h1><a name="overview">&#160;</a>Overview</h1>

<p>The WAN Gateway provides a simple way of creating a master-slave topology enabling data from one XAP site to be replicated to one or more remote sites. For instance, given three clusters in New York, London, and Hong Kong, with New York being the master and the remaining two acting as slaves, any updates to the New York space will propagate to both London and Hong Kong asynchronously. The sample processing units and configuration provided below are intended as an example of implementing a single-master/multi-slave topology across three sites: New York (US), London (GB), and Hong Kong (HK) where each site has an independent cluster and a Gateway.
<img src="/attachment_files/sbp/WAN_masterslave.png" alt="WAN_masterslave.png" /></p>

<p>The demo is configured to start three space instances across three clusters. While the three clusters run on your local machine, they are demarcated by zones and different lookup service ports as follows:</p>

<table>
<thead>
<tr>
<th align="left">Gateway/Space</th>
<th align="center">Zone</th>
<th align="center">Lookup Service Port</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">wan-gateway-HK</td>
<td align="center">HK</td>
<td align="center">4166</td>
</tr>

<tr>
<td align="left">wan-space-HK</td>
<td align="center">HK</td>
<td align="center">4166</td>
</tr>

<tr>
<td align="left">wan-gateway-US</td>
<td align="center">US</td>
<td align="center">4266</td>
</tr>

<tr>
<td align="left">wan-space-US</td>
<td align="center">US</td>
<td align="center">4266</td>
</tr>

<tr>
<td align="left">wan-gateway-GB</td>
<td align="center">GB</td>
<td align="center">4366</td>
</tr>

<tr>
<td align="left">wan-space-GB</td>
<td align="center">GB</td>
<td align="center">4366</td>
</tr>
</tbody>
</table>

<p>The internal architecture of the setup includes a clustered space and a Gateway, such that the master site (US) only configures delegators while the slave sites (GB, HK) only configure sinks (click the thumbnail to enlarge):</p>

<p><a href="/attachment_files/sbp/WAN_masterslave_arch.png"><img src="/attachment_files/sbp/WAN_masterslave_arch.png" width="140" height="100"></a></p>

<p>As a result of this topology setup, the following scenario will take place once updates are written to the New York space:</p>

<ol>
<li>All updates performed on the New York cluster are sent to local delegators for London and Hong Kong</li>
<li>London and Hong Kong sinks will receive the updates asynchronously</li>
<li>London and Hong Kong sinks apply the updates on their local cluster</li>
</ol>

<h1><a name="configuring-master-slave-replication">&#160;</a>Configuring Master-Slave Replication</h1>

<p>The master-slave topology configuration is simply implemented through delegators on the master (New York) and a sink on each slave (London, Hong Kong). In this case, New York's site will be the active site while London and
Hong Kong will be the passive sites. While the slave sites are passive,  this does not necessarily mean that no work is done in these sites. However,
in  terms of replication over the WAN, these sites should not replicate to  the other sites and usually should not alter data replicated from other
 sites because it may cause conflicts:</p>

<div class="easyui-tabs" plain="true" data-options=""><div title="New York Space" style="padding:10px"><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:os-core="http://www.openspaces.org/schema/core" xmlns:os-events="http://www.openspaces.org/schema/events"
    xmlns:tx="http://www.springframework.org/schema/tx" xmlns:os-remoting="http://www.openspaces.org/schema/remoting"
    xmlns:os-gateway="http://www.openspaces.org/schema/core/gateway"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://www.openspaces.org/schema/core http://www.openspaces.org/schema/14.0/core/openspaces-core.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
       http://www.openspaces.org/schema/events http://www.openspaces.org/schema/events/openspaces-events.xsd
       http://www.openspaces.org/schema/core/gateway http://www.openspaces.org/schema/14.0/core/gateway/openspaces-gateway.xsd
       http://www.openspaces.org/schema/remoting http://www.openspaces.org/schema/remoting/openspaces-remoting.xsd"&gt;
    &lt;context:annotation-config&gt;&lt;/context:annotation-config&gt;
    &lt;tx:annotation-driven transaction-manager="transactionManager" /&gt;

    &lt;os-core:distributed-tx-manager id="transactionManager" /&gt;

    &lt;os-events:annotation-support /&gt;

    &lt;os-core:embedded-space id="space" name="wanSpaceUS" gateway-targets="gatewayTargets" /&gt;
    &lt;os-core:giga-space id="gigaSpace" space="space" /&gt;

    &lt;os-core:giga-space-context /&gt;

    &lt;os-gateway:targets id="gatewayTargets"     local-gateway-name="US"&gt;
        &lt;os-gateway:target name="GB" /&gt;
        &lt;os-gateway:target name="HK" /&gt;
    &lt;/os-gateway:targets&gt;
&lt;/beans&gt;

</code></pre>
</div>

<div title="  New York Gateway " style="padding:10px"><pre><code class="language-xml">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:os-gateway="http://www.openspaces.org/schema/core/gateway"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.openspaces.org/schema/core/gateway
       http://www.openspaces.org/schema/[%=Versions.product-version-short%]/core/gateway/openspaces-gateway.xsd"&gt;

    &lt;os-gateway:delegator id="delegator" local-gateway-name="US" gateway-lookups="gatewayLookups"&gt;
        &lt;os-gateway:delegation target="GB" /&gt;
        &lt;os-gateway:delegation target="HK" /&gt;
    &lt;/os-gateway:delegator&gt;

    &lt;os-gateway:lookups id="gatewayLookups"&gt;
        &lt;os-gateway:lookup gateway-name="US" host="localhost" discovery-port="10768" communication-port="7000"/&gt;
        &lt;os-gateway:lookup gateway-name="GB" host="localhost" discovery-port="10769" communication-port="8000"/&gt;
        &lt;os-gateway:lookup gateway-name="HK" host="localhost" discovery-port="10770" communication-port="9000"/&gt;
    &lt;/os-gateway:lookups&gt;

&lt;/beans&gt;

</code></pre>
</div>

<div title="  London Space " style="padding:10px"><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:os-core="http://www.openspaces.org/schema/core" xmlns:os-events="http://www.openspaces.org/schema/events"
    xmlns:tx="http://www.springframework.org/schema/tx" xmlns:os-remoting="http://www.openspaces.org/schema/remoting"
    xmlns:os-gateway="http://www.openspaces.org/schema/core/gateway"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://www.openspaces.org/schema/core http://www.openspaces.org/schema/14.0/core/openspaces-core.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
       http://www.openspaces.org/schema/events http://www.openspaces.org/schema/events/openspaces-events.xsd
       http://www.openspaces.org/schema/core/gateway http://www.openspaces.org/schema/14.0/core/gateway/openspaces-gateway.xsd
       http://www.openspaces.org/schema/remoting http://www.openspaces.org/schema/remoting/openspaces-remoting.xsd"&gt;
    &lt;context:annotation-config&gt;&lt;/context:annotation-config&gt;
    &lt;tx:annotation-driven transaction-manager="transactionManager" /&gt;

    &lt;os-core:distributed-tx-manager id="transactionManager" /&gt;

    &lt;os-events:annotation-support /&gt;

    &lt;os-core:embedded-space id="space" name="wanSpaceGB" /&gt;
    &lt;os-core:giga-space id="gigaSpace" space="space" /&gt;

    &lt;os-core:giga-space-context /&gt;

&lt;/beans&gt;

</code></pre>
</div>

<div title="  London Gateway " style="padding:10px"><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:os-gateway="http://www.openspaces.org/schema/core/gateway"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.openspaces.org/schema/core/gateway
       http://www.openspaces.org/schema/[%=Versions.product-version-short%]/core/gateway/openspaces-gateway.xsd"&gt;

    &lt;os-gateway:sink id="sink" local-gateway-name="GB" gateway-lookups="gatewayLookups"
                     local-space-url="jini://*/*/wanSpaceGB"&gt;
        &lt;os-gateway:sources&gt;
            &lt;os-gateway:source name="US"/&gt;
        &lt;/os-gateway:sources&gt;
    &lt;/os-gateway:sink&gt;

    &lt;os-gateway:lookups id="gatewayLookups"&gt;
        &lt;os-gateway:lookup gateway-name="US" host="localhost" discovery-port="10768" communication-port="7000"/&gt;
        &lt;os-gateway:lookup gateway-name="GB" host="localhost" discovery-port="10769" communication-port="8000"/&gt;
        &lt;os-gateway:lookup gateway-name="HK" host="localhost" discovery-port="10770" communication-port="9000"/&gt;
    &lt;/os-gateway:lookups&gt;

&lt;/beans&gt;

</code></pre>
</div>

<div title="  Hong Kong Space " style="padding:10px"><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:os-core="http://www.openspaces.org/schema/core" xmlns:os-events="http://www.openspaces.org/schema/events"
    xmlns:tx="http://www.springframework.org/schema/tx" xmlns:os-remoting="http://www.openspaces.org/schema/remoting"
    xmlns:os-gateway="http://www.openspaces.org/schema/core/gateway"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
       http://www.openspaces.org/schema/core http://www.openspaces.org/schema/14.0/core/openspaces-core.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
       http://www.openspaces.org/schema/events http://www.openspaces.org/schema/events/openspaces-events.xsd
       http://www.openspaces.org/schema/core/gateway http://www.openspaces.org/schema/14.0/core/gateway/openspaces-gateway.xsd
       http://www.openspaces.org/schema/remoting http://www.openspaces.org/schema/remoting/openspaces-remoting.xsd"&gt;
    &lt;context:annotation-config&gt;&lt;/context:annotation-config&gt;
    &lt;tx:annotation-driven transaction-manager="transactionManager" /&gt;

    &lt;os-core:distributed-tx-manager id="transactionManager" /&gt;

    &lt;os-events:annotation-support /&gt;

    &lt;os-core:embedded-space id="space" name="wanSpaceHK" /&gt;
    &lt;os-core:giga-space id="gigaSpace" space="space" /&gt;

    &lt;os-core:giga-space-context /&gt;
    &lt;os-remoting:annotation-support /&gt;

&lt;/beans&gt;
</code></pre>
</div>

<div title="  Hong Kong Gateway " style="padding:10px"><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:os-gateway="http://www.openspaces.org/schema/core/gateway"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
       http://www.openspaces.org/schema/core/gateway
       http://www.openspaces.org/schema/[%=Versions.product-version-short%]/core/gateway/openspaces-gateway.xsd"&gt;

    &lt;os-gateway:sink id="sink" local-gateway-name="HK" gateway-lookups="gatewayLookups"
                     local-space-url="jini://*/*/wanSpaceHK"&gt;
        &lt;os-gateway:sources&gt;
            &lt;os-gateway:source name="US"/&gt;
        &lt;/os-gateway:sources&gt;
    &lt;/os-gateway:sink&gt;

     &lt;os-gateway:lookups id="gatewayLookups"&gt;
        &lt;os-gateway:lookup gateway-name="US" host="localhost" discovery-port="10768" communication-port="7000"/&gt;
        &lt;os-gateway:lookup gateway-name="GB" host="localhost" discovery-port="10769" communication-port="8000"/&gt;
        &lt;os-gateway:lookup gateway-name="HK" host="localhost" discovery-port="10770" communication-port="9000"/&gt;
    &lt;/os-gateway:lookups&gt;

&lt;/beans&gt;

</code></pre>
</div>
</div>

<h1><a name="installing-and-running-the-example">&#160;</a>Installing and Running the Example</h1>

<ol>
<li>Download the <a href="https://github.com/Gigaspaces/wan-gateway-examples/archive/master.zip">WAN-Gateway-Examples.zip</a> archive. It includes two folders: <span class="tc-bold">deploy</span> and <span class="tc-bold">scripts</span>. View on <a href="https://github.com/Gigaspaces/wan-gateway-examples/tree/master/WAN_Replication_MasterSlave">GitHub</a></li>
<li>Please extract the file and and copy the content of the <span class="tc-bold">deploy</span> folder into <code>\&lt;GIGASPACES_HOME&gt;\deploy</code> folder.</li>
<li>Extract the <code>scripts</code> folder to an arbitrary location and edit the <code>setExampleEnv.bat/sh</code> script to include correct values for <code>NIC_ADDR</code> as the machine IP and <code>GS_HOME</code> as the GigaSpaces root folder location.</li>
</ol>

<p>The <code>scripts</code> folder contains the necessary scripts to start the <a href="/product_overview/service-grid.html#gsa">Grid Service Agent</a> for each cluster, in addition to a deploy script <code>deployAll.bat/sh</code> which will be used to automate the deployment of all three gateways and space instances. This will allow you to run the entire setup on one machine to simplify testing. Here are the steps to run the example:</p>

<ol>
<li>Run <code>startAgent-GB.bat/sh</code> or to start GB site.</li>
<li>Run <code>startAgent-HK.bat/sh</code> to start HK site.</li>
<li>Run <code>startAgent-US.bat/sh</code> to start US site.</li>
<li>Run <code>deployAll.bat/sh</code> file to deploy all the processing units listed above.</li>
</ol>

<h1><a name="viewing-the-clusters">&#160;</a>Viewing the Clusters</h1>

<ul>
<li>Start the GigaSpaces Management Center and configure the appropriate lookup groups through the "Group Management" dialog.</li>
<li>Once all clusters are up and running, you will need to enable the relative groups:</li>
</ul>

<p><img src="/attachment_files/sbp/group_management_dialog.jpg" alt="group_management_dialog.jpg" /></p>

<p>Check to enable all three advertised groups for each site:</p>

<p><img src="/attachment_files/sbp/groups_selection_dialog.jpg" alt="groups_selection_dialog.jpg" /></p>

<p>As a result, you should see the service grid components for each site displayed under the "Hosts" tree as follows:</p>

<p><a href="/attachment_files/sbp/masterslave_hosts_view.png"><img src="/attachment_files/sbp/masterslave_hosts_view.png" width="140" height="100"></a></p>

<p>Once The deployAll.bat/sh script finishes running, you should be able to see all three sites deployed as follows:</p>

<p><a href="/attachment_files/sbp/pu_deployments.jpg"><img src="/attachment_files/sbp/pu_deployments.jpg" width="140" height="100"></a></p>

<p>If you are using the GS-WEBUI, you can also view the site topology through the "Data Grids &gt; Gateways" view as the following:</p>

<p><a href="/attachment_files/sbp/webui_gw_topology.png"><img src="/attachment_files/sbp/webui_gw_topology.png" width="140" height="100"></a></p>

<h1><a name="testing-master-slave-replication">&#160;</a>Testing Master-Slave Replication</h1>

<p>You can test the setup by using the <a href="/xap/14.0/admin/benchmark-browser.html">benchmark utility</a> comes with the GS-UI. Select the US Benchmark icons and click Start to begin writing objects to the space:</p>

<p><a href="/attachment_files/sbp/masterslave_space_write.png"><img src="/attachment_files/sbp/masterslave_space_write.png" width="140" height="100"></a></p>

<p>Click the Spaces icon on the Space Browser Tab to get a global view of all spaces. As objects are being written, you should see replication occurring across both HK and GB sites until there are 5000 objects in each space:</p>

<p><a href="/attachment_files/sbp/masterslave_space_count.png"><img src="/attachment_files/sbp/masterslave_space_count.png" width="140" height="100"></a></p>

</body>
</html>