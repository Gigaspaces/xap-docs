<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body>
        <div class="product-bar">
            <p><a><MadCap:variable name="General.ProductXAP" /></a>
            </p>
        </div>
        <h1 class="tc-pagetitle">Tiered Storage&#160;Configuration for Service Grid</h1>
        <h1>Initial Load</h1>
        <p>The initial loading of data into each tier can be a time-consuming process, starting with the System of Record or other external data sources. Additionally, data in both tiers can be updated during the normal course of operations during the day.</p>
        <p>During the normal use of Tiered Storage, priority data is stored in the Hot tier, and other data (except transient) is stored in the Warm tier. If there is data in the Warm tier, it will be faster to recover it rather than recovering it from an external database.</p>
        <ul>
            <li>
                <p>Initial load from external data source will be performed as usual if the local Database (DB) is empty (empty = no metadata).</p>
            </li>
            <li>
                <p>If the local DB is not empty, the data of the primary will  be loaded from the local disk and backup will perform recovery from primary (delete disk data in init).</p>
            </li>
            <li>
                <p>We use ZooKeeper (ZK) persistent to store the last primary of each partition and where each instance should be located, so election will  be performed as before.</p>
            </li>
            <li>
                <p><code>pu.autogenerated-instance-sla="true"</code> to allow auto generation of sla per instance.</p>
            </li>
            <li>
                <p>In the case of deploy/undeploy with a different number of partitions, an API needs to be called to clean the internal database and configuration, otherwise the initial load will fail.</p>
            </li>
        </ul>
        <p>Using data persistency, data in both tiers is stored in a system repository. When the data is undeployed, the user has an option to persist the data. Subsequent redeployment of the data is performed at optimum speed.</p>
        <h2>Log:&#160;Source of Data </h2>
        <p>In the primary Space log:</p>
        <p><code class="language-bash">Recovery from tier layer</code>
        </p>
        <p><code class="language-bash">Data source recovery</code>
        </p>
        <p><code class="language-bash">Entries found in warm tier:</code>
        </p>
        <p><code class="language-bash">Entries inserted to hot tier:</code>
        </p>
        <p><code class="language-bash">Total Time:</code>
        </p>
        <p>This data can be compared with primary log of the initial run Recovery from  external data source:</p>
        <p><code class="language-bash">Entries found in data source</code>
        </p>
        <p><code class="language-bash">Entries inserted to Space:</code>
        </p>
        <p><code class="language-bash">Entries ignored:</code>
        </p>
        <p><code class="language-bash">Total Time:</code>
        </p>
        <h2>Transient Objects</h2>
        <ul>
            <li>
                <p>Transient objects are not kept in SQLite but can still be mirrored to an external source.</p>
                <ul>
                    <li>
                        <p>In this case, after undeploy+deploy, the transient objects will not be in the Space.</p>
                    </li>
                </ul>
            </li>
        </ul>
        <ul>
            <li>
                <p>If it is required to load from an external source, delete pu metadata &amp; data.</p>
            </li>
        </ul>
        <h2>Tiered Storage Configuration for Space Types</h2>
        <h3>Registering a Space Type with Tiered&#160;Storage Configuration</h3>
        <p>In the Java example below, take note of the highlighted section.</p><pre><code class="language-java">SpaceTypeDescriptor typeDescriptorDoc1 = 
   <span style="color: #4169e1;">new</span> SpaceTypeDescriptorBuilder(<span style="color: #008000;">"SpaceTypeExample"</span>)
	.addFixedProperty(<span style="color: #008000;">"id"</span>, <span style="color: #4b0082;">Integer</span>.<span style="color: #4169e1;">class</span>)
	.addFixedProperty(<span style="color: #008000;">"field1"</span>, <span style="color: #4b0082;">String</span>.<span style="color: #4169e1;">class</span>)
	.addFixedProperty(<span style="color: #008000;">"field2"</span>, <span style="color: #4b0082;">String</span>.<span style="color: #4169e1;">class</span>)
	.addFixedProperty(<span style="color: #008000;">"field3"</span>, <span style="color: #4b0082;">String</span><span style="color: #4169e1;">.class</span>)
	.addFixedProperty(<span style="color: #008000;">"expireDate"</span>, LocalDateTime.<span style="color: #4169e1;">class</span>)
	.idProperty("id")
	.supportsDynamicProperties(false)
	.setTieredStorageTableConfig(
		<span style="background-color: #ffff00;">new TieredStorageTableConfig()</span>
			&gt;<span style="background-color: #ffff00;">.setName("SpaceTypeExample")</span><span style="color: #c71585;">// set to space type name</span>
			&gt;<span style="background-color: #ffff00;">.setCriteria("field1='1'")</span><span style="color: #c71585;">// see examples below</span>
	)
	.create()
</code></pre>
        <h2>Tiered Storage&#160;Policies in Type Registration</h2>
        <table style="width: 100%;" class="tc-standard">
            <col style="width: 364px;" />
            <col />
            <thead>
                <tr>
                    <th style="font-weight: bold;">Example</th>
                    <th style="text-align: left;font-weight: bold;">Hot/Warm Tiers Distribution</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>new TieredStorageTableConfig()
 .setName("SpaceTypeExample")
 .setCriteria("field1='1'")
Note: Supported operators:
= != &gt;= &lt;= and or</td>
                    <td>
                        <p>Criteria-Based
</p>
                        <table style="width: 100%;">
                            <col />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>Matching provided criteria</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>new TieredStorageTableConfig()
 .setName("SpaceTypeExample")
 .setTimeColumn("expireDate")
 .setPeriod(Duration.ofMinutes(60))
</td>
                    <td>
                        <p>Time-Based</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>Matching condition expireDate+60min&lt;now</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                        <p>Note: Only the initial value of the expireDate column will define Hot Tier retention of an object.</p>
                    </td>
                </tr>
                <tr>
                    <td>new TieredStorageTableConfig()
 .setName("SpaceTypeExample")
 .setTransient(true)</td>
                    <td>
                        <p>Memory&#160;Only</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>All</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>None</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>null
(*) or no call to:
.setTieredStorageTableConfi</td>
                    <td>
                        <p>Warm Tier Only</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>None</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>new TieredStorageTableConfig()
 .setName("SpaceTypeExample")
 .setCriteria("all")</td>
                    <td>
                        <p>Hot and Warm</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>All</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>
        </table>
        <h2>Tiered Storage Configuration in&#160;Pluggable Connector</h2>
        <p>Pluggable Connector provides a configuration option ‘tiering’ for configuring tiered storage rules:</p><pre><code class="language-java"><span style="color: #4169e1;">
dataFormat:</span><span style="color: #006400;">"JSON"</span><span style="color: #4169e1;">
spaceTypes:</span><![CDATA[
]]><span style="color: #4169e1;">- name:</span> "SpaceTypeExample"<span style="color: #4169e1;">
  dataSource:</span><![CDATA[
	]]><span style="color: #4169e1;">topic:</span><span style="color: #006400;"> "topic"</span><![CDATA[
	]]><span style="color: #4169e1; background-color: #ffff00;">tiering:</span><span style="color: #006400;">“hot-and-warm”</span><span style="color: #4169e1;">
  properties</span>:
  <span style="color: #4169e1;">- name:</span><span style="color: #006400;"> "id"</span><![CDATA[
	]]><span style="color: #4169e1;">type:</span><span style="color: #006400;">"java.lang.Integer"</span><![CDATA[
	]]><span style="color: #4169e1;">selector: </span><span style="color: #006400;">"$.id"</span><![CDATA[
	]]><span style="color: #4169e1;">attributes:</span><span style="color: #006400;">["spaceid"]</span><![CDATA[
  ]]><span style="color: #4169e1;">- name: </span><span style="color: #006400;">"field1"</span><![CDATA[
	]]><span style="color: #4169e1;">type:</span><span style="color: #006400;">"java.lang.String"</span><![CDATA[
	]]><span style="color: #4169e1;">selector:</span><span style="color: #006400;"> "$.field1"</span><![CDATA[
 ]]><span style="color: #4169e1;"> - name:</span><span style="color: #006400;">"expireDate"</span><![CDATA[
	 ]]><span style="color: #4169e1;">type:</span><span style="color: #006400;">"java.time.LocalDateTime"</span><![CDATA[
	 ]]><span style="color: #4169e1;">selector:</span><span style="color: #006400;">"$.expireDate"</span><![CDATA[
]]></code></pre>
        <h3>Supported Value&#160;Formats</h3>
        <table style="width: 100%;" class="tc-standard">
            <col style="width: 364px;" />
            <col />
            <thead>
                <tr>
                    <th style="font-weight: bold;">Example</th>
                    <th style="text-align: left;font-weight: bold;">Hot/Warm Tiers Distribution</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>criteria: field1='1'</td>
                    <td>
                        <p>Criteria-Based
</p>
                        <table style="width: 100%;">
                            <col />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>Matching provided criteria</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>period: expireDate 60min </td>
                    <td>
                        <p>Time-Based</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>Matching condition expireDate+60min&lt;now</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                        <p>Note: Only the initial value of the expireDate column will define Hot Tier retention of an object.</p>
                    </td>
                </tr>
                <tr>
                    <td>hot-only</td>
                    <td>
                        <p>Memory&#160;Only</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>All</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>None</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>warm-only</td>
                    <td>
                        <p>Warm Tier Only</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>None</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>hot-and-warm</td>
                    <td>
                        <p>Hot and Warm</p>
                        <table style="width: 100%;">
                            <col style="width: 299px;" />
                            <col />
                            <tbody>
                                <tr>
                                    <td>Hot Tier</td>
                                    <td>All</td>
                                </tr>
                                <tr>
                                    <td>Warm Tier</td>
                                    <td>All</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>
        </table>
        <h1>Underploy-Deploy </h1>
        <p>In the case of deploying using a different topology:</p>
        <p>
            <img src="../Resources/Images/17.0/Tier1.png" style="width: 686px;height: 360px;" />
        </p>
        <h2>The Undeployed Processing Units (PUs)</h2>
        <p>The undeployed services can be viewed using the <code>GET /pus/undeployed</code> REST API. <br /></p>
        <p>
            <img src="../Resources/Images/17.0/Tier2.png" />
        </p>
        <p>An example of sample output is shown below.</p><pre><code class="language-bash"> [
				{
				"name": "space-10-SNAPSHOT",
				"unDeployedAt": "2021-08-03T12:18:25.437",
				"isPersistent": true,
				"gracefulShutdown": true,
				"lastPrimaries": [
				{
				"partitionId": 1,
				"insatnceId": "1_1"
				}
				],
				"spaceInstancesHosts": [
				{
				"instanceId": "1_0",
				"host": "127.0.1.1"
				},
				{
				"instanceId": "1_1",
				"host": "127.0.1.1"
				}
				],
				"schema": "partitioned",
				"numOfInstances": 1,
				"backupsPerPartition": 1
				}
</code></pre>
        <h1>Deleting Previous&#160;Data and Metadata</h1>
        <p>
            <img src="../Resources/Images/17.0/Tier3.png" />
        </p>
        <h1>Safe Undeploy:&#160;Ensure all Data in&#160;Disk is Updated</h1>
        <p>Added options to undeploy: DrainMode and DrainTimeout</p>
        <ul>
            <li>
                <p><b>NONE</b>     - <i>make no attempt to</i> wait for all data to be drained before shutting down</p>
            </li>
            <li>
                <p><b>REQUIRED</b> - make an attempt to wait for all data to be drained before shutting down,</p>
            </li>
            <li>
                <p><i>shutdown even if drain wasn't completed</i> before drainTimeout</p>
            </li>
            <li>
                <p><b>ATTEMPT</b>  - make an attempt to wait for all data to be drained before shutting down,</p>
            </li>
            <li>
                <p><i>shutdown will not occur if drain wasn't completed</i> before drainTimeout</p>
            </li>
        </ul>
        <p>Admin API:</p>
        <p><code>pu.undeployAsync(new UndeployOptions(DrainMode.ATTEMPT,60000L));</code>
        </p>
        <p>CLI: </p>
        <p><code>./gs.sh service undeploy --drain-mode=ATTEMPT --drain-timeout=60000ms  test.</code>
        </p>
        <p>If drain was not completed with mode attempt, the PU will be at quiesce status.</p>
        <p>Even if undeploy did not drain all, data is considered as consistent and will recover from disk in the case where it is not empty. The same goes for failover with async replication.</p>
        <h2>Undeploy - REST</h2>
        <p>The data of undeployed services can be deleted using the <code>DELETE /pus/undeployed/{id}</code> REST API.</p>
        <p>
            <img src="../Resources/Images/17.0/Tier4.png" />
        </p>
        <h1>Limitations and Recommendations</h1>
        <table style="width: 100%;" class="tc-standard">
            <col style="width: 677px;" />
            <col />
            <thead>
                <tr>
                    <th><b>Supported</b>
                    </th>
                    <th style="text-align: left;font-weight: bold;">Not Supported</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <ul>
                            <li>
                                <p style="font-size: 12pt;">Broadcast Table: Recommended all (both disk and cache)
</p>
                            </li>
                            <li>
                                <p><span style="font-size: 12pt;">At this stage, primitive property types and selected Java classes are supported in Tiered Storage.</span>
                                </p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Property Types: Only native value types (integer, string, double, byte, data types, array, etc.)
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">SpaceDocument: Only fixed properties
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">The number of backups per partition is zero or one
                                </p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">16.2+: Transaction Support: Local transactions are supported
LocalView
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">16.3+: K8s
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">16.3+: Dynamic Indexes
 </p>
                            </li>
                        </ul>
                    </td>
                    <td style="text-align: left;">
                        <ul>
                            <li>
                                <p style="font-size: 12pt;">Storage Optimization</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Tiered Storage policies cannot be changed after Space Type registration.</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">
Inheritance
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">FIFO
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Lease (for non-transient types). Cannot have both time and criteria for the same type.
Compound Indexes (id is the exception)
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Scale In/Out
</p>
                            </li>
                        </ul>
                        <p>&#160;</p>
                        <p>&#160;</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <p>&#160;</p>
    </body>
</html>