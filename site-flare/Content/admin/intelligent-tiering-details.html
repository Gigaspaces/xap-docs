<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body>
        <div class="product-bar">
            <p><a><MadCap:variable name="General.ProductXAP" /></a>
            </p>
        </div>
        <h1 class="tc-pagetitle">Tiered Storage&#160;Configuration for Service Grid</h1>
        <h1>Initial Load</h1>
        <p>The initial loading of data into each tier can be a time-consuming process, starting with the System of Record or other external data sources. Additionally, data in both tiers can be updated during the normal course of operations during the day.</p>
        <p>During the normal use of Tiered Storage, priority data is stored in the Hot tier, and other data is stored in the Warm tier.</p>
        <ul>
            <li>
                <p>Initial load from external data source will be performed as usual if the local Database (DB) is empty (empty = no metadata).</p>
            </li>
            <li>
                <p>If the local DB is not empty, the data of the primary will  be loaded from the local disk and backup will perform recovery from primary (delete disk data in init).</p>
            </li>
            <li>
                <p>We use ZooKeeper (ZK) persistent to store the last primary of each partition and where each instance should be located, so election will  be performed as before.</p>
            </li>
            <li>
                <p><code>pu.autogenerated-instance-sla="true"</code> to allow auto generation of sla per instance.</p>
            </li>
            <li>
                <p>In the case of deploy/undeploy with a different number of partitions, an API needs to be called to clean the internal database and configuration, otherwise the initial load will fail.</p>
            </li>
        </ul>
        <p>Using data persistency, data in both tiers is stored in a system repository. When the data is undeployed, the user has an option to persist the data. Subsequent redeployment of the data is performed at optimum speed.</p>
        <h2>Log:&#160;Source of Data </h2>
        <p>In the primary space log:</p>
        <p><code class="language-bash">Recovery from tier layer</code>
        </p>
        <p><code class="language-bash">Data source recovery</code>
        </p>
        <p><code class="language-bash">Entries found in warm tier:</code>
        </p>
        <p><code class="language-bash">Entries inserted to hot tier:</code>
        </p>
        <p><code class="language-bash">Total Time:</code>
        </p>
        <p>This data can be compared with primary log of the initial run Recovery from  external data source:</p>
        <p><code class="language-bash">Entries found in data source</code>
        </p>
        <p><code class="language-bash">Entries inserted to space:</code>
        </p>
        <p><code class="language-bash">Entries ignored:</code>
        </p>
        <p><code class="language-bash">Total Time:</code>
        </p>
        <h2>Transient Objects</h2>
        <ul>
            <li>
                <p>Transient objects are not kept in SQLite but can still be mirrored to an external source.</p>
                <ul>
                    <li>
                        <p>In this case, after undeploy+deploy, the transient objects will not be in the space.</p>
                    </li>
                </ul>
            </li>
        </ul>
        <ul>
            <li>
                <p>If it is required to load from an external source, delete pu metadata &amp; data.</p>
            </li>
        </ul>
        <h1>Underploy-Deploy </h1>
        <p>In the case of deploying using a different topology:</p>
        <p>
            <img src="../Resources/Images/17.0/Tier1.png" style="width: 686px;height: 360px;" />
        </p>
        <h2>The Undeployed Processing Units (PUs)</h2>
        <p>The undeployed services can be viewed using the <code>GET /pus/undeployed</code> REST API. <br /></p>
        <p>
            <img src="../Resources/Images/17.0/Tier2.png" />
        </p>
        <p>An example of sample output is shown below.</p><pre><code class="language-bash"> [
				{
				"name": "space-10-SNAPSHOT",
				"unDeployedAt": "2021-08-03T12:18:25.437",
				"isPersistent": true,
				"gracefulShutdown": true,
				"lastPrimaries": [
				{
				"partitionId": 1,
				"insatnceId": "1_1"
				}
				],
				"spaceInstancesHosts": [
				{
				"instanceId": "1_0",
				"host": "127.0.1.1"
				},
				{
				"instanceId": "1_1",
				"host": "127.0.1.1"
				}
				],
				"schema": "partitioned",
				"numOfInstances": 1,
				"backupsPerPartition": 1
				}
</code></pre>
        <h1>Deleting Previous&#160;Data and Metadata</h1>
        <p>
            <img src="../Resources/Images/17.0/Tier3.png" />
        </p>
        <h1>Safe Undeploy:&#160;Ensure all Data in&#160;Disk is Updated</h1>
        <p>Added options to undeploy: DrainMode and DrainTimeout</p>
        <ul>
            <li>
                <p><b>NONE</b>     - <i>make no attempt to</i> wait for all data to be drained before shutting down</p>
            </li>
            <li>
                <p><b>REQUIRED</b> - make an attempt to wait for all data to be drained before shutting down,</p>
            </li>
            <li>
                <p><i>shutdown even if drain wasn't completed</i> before drainTimeout</p>
            </li>
            <li>
                <p><b>ATTEMPT</b>  - make an attempt to wait for all data to be drained before shutting down,</p>
            </li>
            <li>
                <p><i>shutdown will not occur if drain wasn't completed</i> before drainTimeout</p>
            </li>
        </ul>
        <p>Admin API:</p>
        <p><code>pu.undeployAsync(new UndeployOptions(DrainMode.ATTEMPT,60000L));</code>
        </p>
        <p>CLI: </p>
        <p><code>./gs.sh service undeploy --drain-mode=ATTEMPT --drain-timeout=60000ms  test.</code>
        </p>
        <p>If drain was not completed with mode attempt, the PU will be at quiesce status.</p>
        <p>Even if undeploy did not drain all, data is considered as consistent and will recover from disk in the case where it is not empty. The same goes for failover with async replication.</p>
        <h2>Undeploy - REST</h2>
        <p>The data of undeployed services can be deleted using the <code>DELETE /pus/undeployed/{id}</code> REST API.</p>
        <p>
            <img src="../Resources/Images/17.0/Tier4.png" />
        </p>
        <h1>Limitations and Recommendations</h1>
        <table style="width: 100%;" class="tc-standard">
            <col style="width: 677px;" />
            <col />
            <thead>
                <tr>
                    <th><b>Supported</b>
                    </th>
                    <th style="text-align: left;font-weight: bold;">Not Supported</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <ul>
                            <li>
                                <p style="font-size: 12pt;">Broadcast Table: Recommended all (both disk and cache)
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Property Types: Only native value types (integer, string, double, byte, data types, array, etc.)
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Space Document: Only fixed properties
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">The number of backups per partition is zero or one
                                </p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">16.2+: Transaction Support: Local transactions are supported
LocalView
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">16.3+: K8s
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">16.3+: Dynamic Indexes
 </p>
                            </li>
                        </ul>
                    </td>
                    <td style="text-align: left;">
                        <ul>
                            <li>
                                <p style="font-size: 12pt;">Storage Optimization</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">
Inheritance
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">FIFO
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Lease (for non-transient types). Cannot have both time and criteria for the same type.
Compound Indexes (id is the exception)
</p>
                            </li>
                            <li>
                                <p style="font-size: 12pt;">Scale In/Out
</p>
                            </li>
                        </ul>
                        <p>&#160;</p>
                        <p>&#160;</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <p> </p>
    </body>
</html>