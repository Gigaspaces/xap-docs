<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body>
        <h1 class="tc-pagetitle">Deploying GigaSpaces in Kubernetes</h1>
        <p>This topic describes how to deploy GigaSpaces products in a Kubernetes environment. The integration is packaged as a <a href="https://docs.helm.sh/developing_charts/#charts">Helm chart</a>. You can deploy the full <MadCap:variable name="General.ProductNameIEP" />, which includes the data grid, using the Helm chart available in the GigaSpaces Helm repository.</p>
        <div class="tc-admon-note">
            <p> Kubernetes can be installed in two ways –</p>
            <ul>
                <li MadCap:conditions="Default.DoNotShow">
                    <p>Use a basic Helm chart to start Manager, and then use GigaSpaces Tools (Ops Manager/<a href="https://docs-staging.gigaspaces.com/15.8/admin/tools-cli.html">CLI</a>/API) for Processing Units management. This method uses Kubernetes Operator and provide all <MadCap:variable name="General.ProductNameXAP" /> functionality. It is the default and is described below.</p>
                </li>
                <li>
                    <p>Use Helm charts only. If you use Helm Charts only, Scale Out/In and deploying/undeploying a service are not available using the Ops Manager or the Command Line Interface.<br />See <MadCap:xref href="kubernetes-data-grid-helm-only.html">Getting Started with GigaSpaces in Kubernetes Using Helm Charts</MadCap:xref> for details on how to install Kubernetes via Helm charts only.</p>
                </li>
            </ul>
        </div>
        <h2>Prerequisites</h2>
        <div class="tc-admon-note">
            <p>The topics in this section assume basic knowledge of <MadCap:variable name="General.ProductNameIE" /> and the data grid. If you aren't familiar with the data grid (at minimum), review the contents of the general <a href="../started/index.html">Getting Started</a> section before performing the tasks described here.</p>
        </div>
        <p>Before beginning to work with the Space and <MadCap:variable name="General.ProductNameIE" />, ensure that you have the following installed on your local machine or a VM:</p>
        <ul>
            <li>
                <p><a href="https://docs.helm.sh/using_helm/#quickstart-guide">Helm</a>
                </p>
            </li>
            <li>
                <p>Kubernetes cluster (cloud, on-premise, or local via <a href="https://kubernetes.io/docs/setup/minikube/">minikube</a>)</p>
            </li>
        </ul>
        <p>This topic describes how to do basic and intermediate-level deployment tasks for the Space and <MadCap:variable name="General.ProductNameIE" /> using simple Helm commands. You can perform these tasks using a Kubernetes minikube, because you only need a single node.</p>
        <h1>Deploying and Managing a Space</h1>
        <h2><a name="Accessin"></a>Accessing the GigaSpaces Helm Charts</h2>
        <p>The Helm package manager is used for installing <MadCap:variable name="General.ProductNameIE" /> and <MadCap:variable name="General.ProductNameXAP" /> in the Kubernetes environment. Helm makes deploying complex applications more portable, supports automatic rollbacks, and is a familiar pattern for developers that is easy to understand.
Moreover, since Helm is open source, there are many community charts available with standard configurations for common application services.</p>
        <p>A Helm chart can be used in a variety of formats and locations; packaged, unpackaged, accessed via a remote URL or even in a chart repository.  The <code>xap</code>, <code>insightedge</code>, <code>smart-cache</code>, <code>smart-ods</code> and <code>smart-augmented-transactions</code> Helm charts are published in the GigaSpaces Helm charts repository at <code>https://resources.gigaspaces.com/helm-charts</code>.</p>
        <h3>Add a Helm Repo to the Repo List</h3>
        <p>You can point to the GigaSpaces Helm repo, so that Helm can locate the <code class="language-bash">xap</code> and <code class="language-bash">insightedge</code> charts for installation:</p><pre><code class="language-bash">helm repo add gigaspaces https://resources.gigaspaces.com/helm-charts</code></pre>
        <div class="tc-admon-note">
            <p>If you're using minikube,  note that the default kubernetes services created by GigaSpaces uses LoadBalancer, which requires running 'minikube tunnel' in the background. For more information see <a href="https://minikube.sigs.k8s.io/docs/commands/tunnel/">minikube tunnel</a>.</p>
        </div>
        <p>Another option is to fetch the GigaSpaces Helm charts that you need and unpack them locally, so you don’t have to repeat the repo name and package version in each command (which has the added benefit of making the commands shorter). For example, you can <MadCap:conditionalText MadCap:conditions="Version.15-5-born,Version.16-1-born"> <code class="language-bash">pull </code>(Helm 3)</MadCap:conditionalText><MadCap:conditionalText MadCap:conditions="Version.15-5-born,Version.16-1-died"><code class="language-bash">fetch </code>(Helm 2) or <code class="language-bash">pull </code>(Helm 3)</MadCap:conditionalText> <MadCap:conditionalText MadCap:conditions="Version.15-5-died">fetch </MadCap:conditionalText>and unpack the Helm chart using the following command:</p>
        <p>
            <p>
                <div class="easyui-tabs" plain="true">
                    <div title="Helm 3">
                        <p><code class="language-bash">helm pull gigaspaces/insightedge-manager --version=[%=Versions.helm-version-MX%] --untar</code>
                        </p>
                    </div>
                </div>
            </p>
        </p>
        <p>The chart is unpacked in a local folder called <code>insightedge</code>, which is referenced in the Helm commands.</p>
        <p>The example command format is shown below.</p><pre><code class="language-bash">helm &lt;&lt;command&gt;&gt; &lt;&lt;name-of-helm-chart&gt;&gt; &lt;&lt;parameters&gt;&gt;</code></pre>
        <div class="tc-admon-note">
            <p>You must fetch every chart that you will be using (for example xap, xap-pu and xap-manager) in your GigaSpaces application environment.</p>
        </div>
        <div MadCap:conditions="NewSet.JustAColorForDivs">
            <h1>Deploying the GigaSpaces Platform</h1>
            <p>In order to prepare the environment for use, first the Platform Manager must be deployed. This deploys two pods: the Manager pod, and the Operator pod.</p>
            <p>Note that Platform Manager is deployed by using a Helm chart, but further operations are performed using the UI, CLI or REST-API tools.</p>
            <p>Type the following Helm command to create a Management Pod called <code class="language-bash">testmanager</code> that deploys Manager and Operator pods:</p>
            <h2>Method 1 (Preferred) – Umbrella Installation</h2>
            <div>
                <p>After adding the GigaSpaces Helm repo, you can install the required chart(s) by referencing the chart name and product package version. </p>
                <p>The example command format is shown below.</p><pre><code class="language-bash">helm install umbrella xap --version 16.1.1 --set metrics.enabled=false,manager.metrics.enabled=false,pu.metrics.enabled=false</code></pre>
            </div>
            <div MadCap:conditions="Default.DoNotShow">
                <h3>Deploy a Space using GigaSpaces Tools</h3>
                <p>After the Management Pod has been deployed and the Platform Manager is available, you can deploy the Space instances and connect them to the Platform Manager.</p>
                <p>See <MadCap:xref href="gs-ops-manager-overview.html">[%=General.ProductNameXAP%] Ops Manager</MadCap:xref> or <MadCap:xref href="tools-cli.html">Command Line Interface (CLI)</MadCap:xref> for information on creating a Space object.</p>
            </div>
        </div>
        <h2>Monitoring the Cluster in Kubernetes</h2>
        <p>You can monitor the cluster you deployed using any of the following administration tools.</p>
        <ul>
            <li>Helm: Run the following command to print the status of the "demo' release in the command window.</li>
        </ul><pre><code class="language-bash">helm status testmanager</code></pre>
        <ul>
            <li>Kubernetes dashboard: run the following command to open a dashboard in your browser, where you can see all the Pods and services by clicking the various tabs. For example, if you're using minikube:</li>
        </ul><pre><code class="language-bash">minikube dashboard</code></pre>
        <ul>
            <li>Kubectl: run the following command to print the name, description, and status of the Pods in the command window. A list of events is also printed, which can be used for troubleshooting purposes. For example, if you detected a problem in one of the Pods, you can see the Pod termination reason and exit code.</li>
        </ul><pre><code class="language-bash">kubectl describe pod</code></pre>
        <div>
            <h2>Additional Helm Charts Available in the GigaSpaces Repo</h2>
            <p style="font-weight: bold;">Helm PU/Space deploy:</p><pre><code class="language-bash">

helm install demo xap-pu --version 16.1.1 –-set manager.name=manager,ha=true,partitions=1,antiAffinity.enabled=true,properties="pu.dynamic-partitioning=true"</code></pre>
            <p style="font-weight: bold;">Helm PU/Scale out/in:</p><pre><code class="language-bash">
kubectl patch pu demo -p ‘{“spec”:{“partitions”: 2}}’ --type=merge</code></pre>
            <h2>Method 2 (Alternative Installation) – Step-By-Step</h2>
            <p>Before using these charts for the first time, you must fetch the chart, as described in <MadCap:xref href="#Accessin">Accessing the GigaSpaces Helm Charts</MadCap:xref> above.</p>
            <ul>
                <li>
                    <p>Use a basic Helm chart to start Manager, and then use GigaSpaces Tools (Ops Manager/<a href="https://docs-staging.gigaspaces.com/15.8/admin/tools-cli.html">CLI</a>/API) for Processing Units management. This method uses Kubernetes Operator and provide all <MadCap:variable name="General.ProductNameXAP" /> functionality. It is the default and is described below.</p>
                </li>
            </ul>
            <div>
                <p>
                    <div class="easyui-tabs" plain="true">
                        <div title="Helm 3">
                            <p>
                                <div class="tc-admon-note">
                                    <p>Ensure that no CRDs are installed. Test this with <code>kubectl get pus</code>. <br />If there are PUs installed, and they are not in the Deployed state, Operator will continue trying to complete the installation until the processing unit is installed.</p>
                                </div>
                                <h3>Install Manager</h3><pre><code class="language-bash">helm install manager xap-manager --version 16.1.1 --set metrics.enabled=false </code></pre>
                                <h3>Install Operator, Webhook and CRD Definition</h3><pre><code class="language-bash">helm install operator xap-operator --version 16.1.1 --set manager.name=manager </code></pre>
                                <h3>Install PU</h3><pre><code class="language-bash">helm install pu xap-pu --version 16..1.1 --set manager.name=manager --set metrics.enabled=false </code></pre>
                                <h3>Ensure That All Pods are Running</h3>
                                <p>Run <code>kubectl get pus</code> and ensure that the deployed processing unit is in the Deployed state</p>
                                <h3>Debugging Tips</h3>
                                <ul>
                                    <li>
                                        <p><b>Cannot delete pus</b> (kubectl delete pus &lt;pu name&gt;), delete command gets hung</p>
                                    </li>
                                </ul>
                                <p style="color: #dc143c;font-weight: bold;">Error: INSTALLATION FAILED: rendered manifests contain a resource that already exists. Unable to continue with install: CustomResourceDefinition "pus.gigaspaces.com" in namespace "" exists and cannot be imported into the current release: invalid ownership metadata; label validation error: missing key "app.kubernetes.io/managed-by": must be set to "Helm"; annotation validation error: missing key "meta.helm.sh/release-name": must be set to "manager"; annotation validation error: missing key "meta.helm.sh/release-namespace": must be set to "default"</p>
                                <p>kubectl get pus</p>
                                <p>kubectl get CustomResourceDefintion</p>
                                <ul>
                                    <li>
                                        <p><b>Attempt to delete processing units and CRD causes a system hang</b>
                                        </p>
                                    </li>
                                </ul>
                                <p>See <a href="https://github.com/kubernetes/kubernetes/issues/60538#issuecomment-369099998">this issue.</a></p>
                                <p>kubectl patch pus/pu -p '{"metadata":{"finalizers":[]}}' --type=merge</p>
                                <ul>
                                    <li>
                                        <p><b>Pod is not initializing</b> but <code>kubectl get pus</code> shows it is in deployed state</p>
                                    </li>
                                </ul>
                                <p>Execute <code>kubectl logs &lt;operator pod&gt;</code>. The logs will show custom and merged values.</p>
                            </p>
                        </div>
                    </div>
                </p>
            </div>
        </div>
    </body>
</html>