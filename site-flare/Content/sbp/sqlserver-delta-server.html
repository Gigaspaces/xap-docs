<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
<head></head>
<body>
<h1>XAP.NET SQL Server Delta Server</h1>
  

<table>
<thead>
<tr>
<th>Author</th>
<th>XAP Version</th>
<th>Last Updated</th>
<th>Reference</th>
<th>Download</th>
</tr>
</thead>

<tbody>
<tr>
<td>Ronnie Guha</td>
<td>9.7.0</td>
<td>April 2014</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h1><a name="overview">&#160;</a>Overview</h1>

<table class="tc-borderless"><tr><td style="width:70%;"><p>Almost every large enterprise system includes legacy applications or backend systems that are communicating with the enterprise main database system for reporting, batch processing, data mining, OLAP and other processing activity. These applications might not need to access the data grid to improve their performance or scalability. They will be using the database directly. Once these systems perform data updates , removing data or add new records to the database, these updates might need to be reflected within the data grid. This synchronization activity ensures the data grid is consistent and up to date with the enterprise main database server.</p>
</td>
<td style="width:30%;"><p><MadCap:snippetBlock src="Resources/Snippets/YouTube.flsnp" MadCap:snippetVariables="Links.YouTube:https://www.youtube.com/watch?v=SQOFuwine9g," /></p>
</td>
</tr></table>

<p>The Delta Server described with this pattern responsible for getting notifications from the database for any user activity (excluding data grid updates) and delegate these to the data grid. You may specify the exact data set updates to be delegated to the data grid by specifying a SQL Query that will indicate which records updates / removal / addition should be reflected within the data grid.</p>

<h1><a name="scenario">&#160;</a>Scenario</h1>

<table class="tc-borderless"><tr><td style="width:80%;"><p>We have an In Memory Data Grid (IMDG) that is used for querying information. The initial load of the IMDG was performed from an SQL Server Database. The IMDG is not used as a system of record in this case - in other words, any changes to the objects in the IMDG are not propagated back into the Database and instead Data-Grid Non-Aware Clients are updating the Database. These updates (insert,update and delete) need to be reflected in the IMDG.</p>
</td>
<td style="width:20%;"><p><img src="/attachment_files/sqlserver-delta-server.jpg" class="tc-thumbnail" /></p>
</td>
</tr></table>

<p>We will show you how you can implement this scenario with XAP.NET. A fully functional example is available <a href="/download_files/SqlDeltaServer.zip">here</a>.</p>

<h1><a name="change-data-capture-cdc">&#160;</a>Change Data Capture (CDC)</h1>

<p>Change Data Capture is a new feature in SQL Server 2008 that records insert, update and delete activity in SQL Server tables.  This feature allows one to record and update an external data warehouse or IMDG with any data that has changed in the source systems since the last time the ETL process was run.  Without CDC determining any rows that were physically deleted or determining what was changed and when is quite cumbersome and difficult.  CDC provides a configurable solution that addresses these requirements and more.</p>

<p>Change data capture records insert, update, and delete activity that is applied to a SQL Server table. This makes the details of the changes available in an easily consumed relational format. Column information and the metadata that is required to apply the changes to a target environment is captured for the modified rows and stored in change tables that mirror the column structure of the tracked source tables. Table-valued functions are provided to allow systematic access to the change data by consumers.</p>

<p>For further information please consult the Microsoft <a href="http://technet.microsoft.com/en-us/library/bb522489.aspx">documentation</a>.
In our example we will only demonstrate the notifications for INSERT, UPDATE and Delete.</p>

<h2><a name="change-data-capture-cdc-setup-and-configuration">&#160;</a>Change Data Capture (CDC) Setup And Configuration</h2>

<p>This setup is for XAP.NET. Please download it here (<a href="http://www.gigaspaces.com/xap-download">http://www.gigaspaces.com/xap-download</a>). After downloading XAP.NET, please run the version appropriate for your platform (x86 or x64). Remember to copy the license you received via email to the appropriate location (e.g. C:\GigaSpaces\XAP.NET 9.7.0 x86\Runtime\gslicense.xml). Next, proceed with starting XAP.NET and monitoring it via the Web-GUI as follows:</p>

<p>a.  Gs-agent - This can be enabled via windows service or by running Gs-agent.exe thus:</p>

<pre><code class="language-bash">C:\GigaSpaces\XAP.NET 9.7.0 x86\NET v4.0.30319\Bin\Gs-agent.exe
</code></pre>

<p>b.  Deploy a space (e.g)</p>

<pre><code class="language-bash">C:\GigaSpaces\XAP.NET 9.7.0 x86\NET v4.0.30319\Bin\Gs-cli deploy-space -cluster total_members=1,1 mydatagrid. Keep this grid name handy as you will be using it later on.
</code></pre>

<p>c.   Run</p>

<pre><code class="language-bash">C:\GigaSpaces\XAP.NET 9.7.0 x86\NET v4.0.30319\Bin\Gs-webui.exe
</code></pre>

<p>and once successful, login to view the UI (e.g at <code>http://localhost:8099/</code>). You can login with the default group XAP-9.7.0-ga-NET-4.0.30319-x86</p>

<p>Keep this grid name (mydatagrid) handy as you will be using it later on.</p>

<p>NOTE: If you would like to capture all the data available before CDC is enabled and the DeltaServer is run, you would need to preload data into the datagrid.</p>

<h4><a name="step-1">&#160;</a>Step 1:</h4>

<p>Note:-Make Sure Sql-Server Agent is enabled.</p>

<p>a Create a database first (e.g. named datagrid)
b Once a database is created, create a table - with our example, let's use the <span class="tc-bold">Person</span> table with columns: ID, Firstname(nvarchar 255), Lastname(nvarchar 255) and Age (int)</p>

<h4><a name="step-2">&#160;</a>Step 2:</h4>

<p>CDC must be enabled at the database level (it is disabled by default).  To enable CDC you must be a member of the sysadmin fixed server role.  You can enable CDC ONLY on any user database (not on system databases).  Execute the following T-SQL script in the database of your choice (e.g. datagrid in the following screenshots):</p>

<pre><code class="language-sql">declare @rc int
exec @rc = sys.sp_cdc_enable_db
select @rc
-- you will find that a new column is added to sys.databases: is_cdc_enabled
select name, is_cdc_enabled from sys.databases
</code></pre>

<p><img src="/attachment_files/sqlserver/sqlserver-pic3.png" alt="image" /></p>

<p><span class="tc-bold">(notice that datagrid has is_cdc_enabled column = 1)</span></p>

<h4><a name="step-3">&#160;</a>Step 3:</h4>

<p>Enable CDC for the Person table. Execute the following system stored procedure to enable CDC for the Person table:</p>

<pre><code class="language-sql">exec sys.sp_cdc_enable_table
    @source_schema = 'dbo', 
    @source_name = 'Person' ,
    @role_name = 'CDCRole',
    @supports_net_changes = 1
</code></pre>

<h4><a name="step-4">&#160;</a>Step 4:</h4>

<p>Enabling CDC at the database and table levels will create certain tables, jobs, stored procedures and functions in the CDC-enabled database. In our case, this is the datagrid table.
You will see a message that two SQL Agent jobs were created; e.g. cdc.datagrid_capture which scans the database transaction log to handle changes to the tables that have CDC enabled, and cdc.datagrid_cleanup which purges the change tables periodically.</p>

<p>You can examine the schema objects created by running the following T-SQL script:</p>

<pre><code class="language-sql">select o.name, o.type, o.type_desc from sys.objects o
join sys.schemas  s on s.schema_id = o.schema_id
where s.name = 'cdc'
</code></pre>

<h4><a name="step-5">&#160;</a>Step 5:</h4>

<p>Create another table to track the last LSN the DeltaServer is processing:</p>

<pre><code class="language-sql">create table dbo.Person_lsn (last_lsn binary(10))
</code></pre>

<h4><a name="step-6">&#160;</a>Step 6:</h4>

<p>Next, create a function to get the last person LSN thus:</p>

<pre><code class="language-sql">   create function dbo.get_last_Person_lsn()
         returns binary(10)
             as
           begin
         declare @last_lsn binary(10)
   select @last_lsn = last_lsn from dbo.Person_lsn
   select @last_lsn = isnull(@last_lsn, sys.fn_cdc_get_min_lsn('dbo_Person'))
      return @last_lsn
      end
</code></pre>

<p>You have created a Scalar-valued Function. Double check this function by right clicking on Programmability-&gt;Functions-&gt;Scalar Valued Functions.</p>

<p><img src="/attachment_files/sqlserver-pic5.png" alt="" /></p>

<h4><a name="step-7">&#160;</a>Step 7:</h4>

<p>Create a stored procedure that will capture data as soon as next person changes are executed:</p>

<pre><code class="language-bash">SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[Capture]
AS
BEGIN
  -- SET NOCOUNT ON added to prevent extra result sets from
  -- interfering with SELECT statements.
  SET NOCOUNT ON;
  declare @begin_lsn binary(10), @end_lsn binary(10)
    -- get the next LSN for Person changes
  select @begin_lsn = dbo.get_last_Person_lsn()
  -- get the last LSN for Person changes
  select @end_lsn = sys.fn_cdc_get_max_lsn()


  -- get all individual changes in the range
  select * from cdc.fn_cdc_get_all_changes_dbo_Person(
   @begin_lsn, @end_lsn, 'all'); 
  -- save the end_lsn in the Person_lsn table
  update dbo.Person_lsn
  set last_lsn = @end_lsn
  if @@ROWCOUNT = 0
  insert into dbo.Person_lsn values(@end_lsn)

END
GO
</code></pre>

<h1><a name="running-the-example">&#160;</a>Running the Example</h1>

<ol>
<li><a href="/download_files/SqlDeltaServer.zip">Download the example</a>. Extract the SqlDeltaServer.zip in a directory of your choice (e.g. C:\temp). Open the project to make some customizations for your project.
a. Change the Database properties according to your environment:</li>
</ol>

<pre><code class="language-xml"># References-&gt;App.config
&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;configuration&gt;
  &lt;connectionStrings&gt;
    &lt;add name="DBSTRING" connectionString="Data Source=YOUR-SERVER\SQL2012;Initial Catalog=datagrid;Integrated Security=True"/&gt;
  &lt;/connectionStrings&gt;
&lt;/configuration&gt;

</code></pre>

<p>Please change them to reflect values according to your set up. You can easily copy this string from visual studio itself (if you have configured the database connection). Head over to Server explorer in Visual Studio, click on Data Connections-&gt;your database connection. On the right hand side, properties window you will see the connection string that you would need to copy/paste in <span class="tc-bold">DBSTRING</span>.</p>

<p><img src="/attachment_files/sqlserver-pic7.png" alt="" /></p>

<p>b. In Program.cs, change your group and/or space connect string if you desire to. Currently, it is set to use:</p>

<pre><code class="language-java">ISpaceProxy spaceProxy = GigaSpacesFactory.FindSpace("jini://*/*/mydatagrid?groups=XAP-9.7.0-ga-NET-4.0.30319-x64");
</code></pre>

<p>Please note that this is the same data grid name (mydatagrid) you have defined before (in first step).</p>

<p>c. If you would like to, you can change the frequency of updates thus (in program.cs) using:</p>

<pre><code class="language-java">timer.Interval = 5000; //set interval of polling here
</code></pre>

<p>d. Now, you can build the solution and test it out. For this, you can either run it from Visual Studio (Ctrl+F5) or you can  run it from <extract directory>\DeltaServer\DeltaServer\bin\Debug(or Release) and run the DeltaServer.exe. Upon running the program, you should be prompted to insert/update/delete or exit the program</p>

<p><img src="/attachment_files/sqlserver-pic8.png" alt="" /></p>

<h2><a name="registering-a-listener-capturing-data-therefore">&#160;</a>Registering a listener, capturing data therefore</h2>

<p>Lets assume we have an <span class="tc-bold">Employee</span> represented in a Person table in the database that we want to be notified when a record is inserted, updated or deleted so we can update the IMDG with the changes. Here is an example of an <span class="tc-bold">ChangeNotificationListener</span>.</p>

<pre><code class="language-csharp">static void ChangeCapture(object sender, ElapsedEventArgs e)
{
         
    ISpaceProxy spaceProxy = GigaSpacesFactory.FindSpace("jini://*/*/mydatagrid?groups=XAP-9.7.0-ga-NET-4.0.30319-x64");

    string _connStr = ConfigurationManager.ConnectionStrings["DBSTRING"].ConnectionString;
            
    SqlConnection con = new SqlConnection(_connStr);
    con.Open();
    SqlCommand cmd = new SqlCommand("Capture", con);
    cmd.CommandType = CommandType.StoredProcedure;
    SqlDataAdapter da = new SqlDataAdapter(cmd);
    // this will query your database and return the result to your datatable
    DataTable dt = new DataTable();
    da.Fill(dt);

    //Insert Query starts
    List&lt;Employee&gt; objEmployee2 = (from item in dt.AsEnumerable()
    where item.Field&lt;int&gt;("__$operation") == 2
    select new Employee()
    {
        Id = item.Field&lt;int&gt;("Id"),
        FirstName = item.Field&lt;string&gt;("FirstName"),
        LastName = item.Field&lt;string&gt;("LastName"),
        Age = item.Field&lt;int&gt;("Age")
    }).ToList();

    var personarray = new Person[objEmployee2.Count];
    for (int i = 0; i &lt; objEmployee2.Count; i++) // Loop through List with for
    {
        personarray[i] = new Person
        {
            Id = objEmployee2[i].Id,
            FirstName = objEmployee2[i].FirstName,
            LastName = objEmployee2[i].LastName,
            Age = objEmployee2[i].Age
        };
             
    }
    spaceProxy.WriteMultiple(personarray);
    //Insert Query ends

    //Update Query starts
    List&lt;Employee&gt; objEmployee3 = (from item in dt.AsEnumerable()
    where item.Field&lt;int&gt;("__$operation") == 4
    select new Employee()
         {
             Id = item.Field&lt;int&gt;("Id"),
             FirstName = item.Field&lt;string&gt;("FirstName"),
             LastName = item.Field&lt;string&gt;("LastName"),
             Age = item.Field&lt;int&gt;("Age")
         }).ToList();

    for (int i = 0; i &lt; objEmployee3.Count; i++) // Loop through List with for
    {
        IdQuery&lt;Person&gt; idQuery = new IdQuery&lt;Person&gt;(objEmployee3[i].Id);
        IChangeResult&lt;Person&gt; changeResult =
                    spaceProxy.Change&lt;Person&gt;(idQuery,
                    new ChangeSet().Set("FirstName", objEmployee3[i].FirstName).Set("LastName", objEmployee3[i].LastName).Set("Age", objEmployee3[i].Age));
    }
    //Update Query ends

    //Delete Query starts
    List&lt;Employee&gt; objEmployee1 = (from item in dt.AsEnumerable()
        where item.Field&lt;int&gt;("__$operation") == 1
         select new Employee()
         {
             Id = item.Field&lt;int&gt;("Id"),
             FirstName = item.Field&lt;string&gt;("FirstName"),
             LastName = item.Field&lt;string&gt;("LastName"),
             Age = item.Field&lt;int&gt;("Age")
         }).ToList();

    var deltearray = new Person[objEmployee1.Count];
    for (int i = 0; i &lt; objEmployee1.Count; i++) // Loop through List with for
    {
        Person template = new Person();
        template.Id = objEmployee1[i].Id;
        spaceProxy.Take&lt;Person&gt;(template);
    }

    //Delete Query ends
    da.Dispose();
    con.Close();
}
</code></pre>

<h4><a name="viewing-data-changes-in-xap-net">&#160;</a>Viewing Data Changes in XAP.NET:</h4>

<p>As you insert/update/delete, please note such changes in the XAP.NET Web UI.</p>

<p><a href="/attachment_files/sqlserver-pic9.png"><img src="/attachment_files/sqlserver-pic9.png" width="400" height="300"></a></p>

</body>
</html>