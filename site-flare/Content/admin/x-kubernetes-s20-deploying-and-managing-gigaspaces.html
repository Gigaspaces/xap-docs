<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body>
        <h1 class="tc-pagetitle">Deploying a Custom Processing Unit</h1>
        <p>This topic describes how to deploy a custom GigaSpaces processing unit (PU) in a Kubernetes environment. </p>
        <div class="tc-admon-note">
            <p>The topics in this section assume basic knowledge of the GigaSpaces platform. If you aren't familiar with GigaSpaces, review the contents of the general <a href="../started/index.html">Getting Started</a> section before performing the tasks described here.</p>
        </div>
        <h2>Prerequisite</h2>
        <ul>
            <li>
                <p>Perform the steps in <MadCap:xref href="kubernetes-s10-deploying-and-managing-gigaspaces.html" class="deploying-and-managing">Deploying and Managing GigaSpaces in Kubernetes</MadCap:xref></p>
            </li>
        </ul>
        <div MadCap:conditions="NewSet.JustAColorForDivs">
            <h1>Building a Java Application</h1>
            <p>We will build a Java application from one of the built-in blueprints available in the<code> gs.bat/sh</code> procedure.</p>
            <p>The blueprint we are using, option 4 in the procedure, is creating a stateless Processing Unit.</p>
            <ol>
                <li>
                    <p>Type <code>blueprint generate</code>. This begins the configuration work flow.</p>
                </li>
                <li>A list of available blueprints is displayed. Press <span class="tc-bold">4</span> to select the blueprint for a stateless PU.<br /><img src="../Resources/Static/images/kubernetes-s20-select-blueprint-4.png" /><br /></li>
                <li>Choose the default target path (my-pu-state;ess) and "n" to take all of the other defaults..<br /><img src="../Resources/Static/images/kubernetes-s20-take-blueprint-4-defaults.png" /><br /></li>
                <li>
                    <p>The project is created, and the target path is displayed. You are prompted to open the project in your default file explorer. Choose "y" to see the project tree.</p>
                </li>
                <p>
                    <img src="../Resources/Static/images/kubernetes-s20-take-blueprint-4-see-project-tree.png" />
                </p>
            </ol>
            <p MadCap:conditions="Default.DoNotShow">Type quit to exec the gs procedure.</p>
            <p MadCap:conditions="Default.DoNotShow">Switch to the my-pu-stateless directory, and enter the maven command to build the project:</p>
            <p MadCap:conditions="Default.DoNotShow">
                <img src="../Resources/Static/images/kubernetes-s20-take-blueprint-4-maven-build.png" />
            </p>
            <h1>Create a Docker Image</h1>
            <p>Create a docker file named <code>Dockerfile</code>, with the following content:</p><pre><code class="language-bash">
FROM gigaspaces/xap-enterprise:16.2.0-m22-wed-19
ADD my-pu-stateless-0.1.jar /opt/gigaspaces/tools/custom-pu/my-pu-stateless-0.1.jar

ENTRYPOINT ["/opt/entrypoint.sh"]
CMD ["host", "run-agent", "--auto"]
</code></pre>
            <p>Create a file named <code>entrypoint.sh</code>, with the following content:</p><pre><code class="language-bash">
#!/bin/bash

if [ -z "$GS_MANAGER_SERVERS" ]; then
    if [ -z "$GS_PUBLIC_HOST"  ]; then
        export GS_MANAGER_SERVERS=$HOSTNAME
    else
        export GS_MANAGER_SERVERS=$GS_PUBLIC_HOST
    fi
fi

/opt/gigaspaces/bin/gs.sh $*
</code></pre>
            <p>Perform a Docker build operation, with the <code>jar</code> file and the <code>entrypoint.sh</code> file in the same directory. This will create a Docker image.</p><pre><code class="language-bash"> Docker build -t my-pu-stateless .</code></pre>
            <p>Deploy the Docker image in GigaSpaces.</p><pre><code class="language-bash">
helm install custom-pu ./xap-pu/ --set manager.name=xap,\
resourceUrl=../tools/custom-pu/my-pu-stateless-0.1.jar,\
livenessProbe.enabled=false,readinessProbe.enabled=false,metrics.enabled=false,\
image.repository=my-pu-stateless,image.tag=latest					
</code></pre>
        </div>
    </body>
</html>