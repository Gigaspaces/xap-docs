<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
<head></head>
<body>
<h1>Embedding Tomcat as a Web Container</h1>
  

<table>
<thead>
<tr>
<th>Author</th>
<th>XAP Version</th>
<th>Last Updated</th>
<th>Reference</th>
<th>Download</th>
</tr>
</thead>

<tbody>
<tr>
<td>Ali Hodroj</td>
<td>9.6</td>
<td>Feb 2014</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h1><a name="overview">&#160;</a>Overview</h1>

<table class="tc-borderless"><tr><td style="width:80%;"><p>GigaSpaces XAP allows for embedding a Tomcat 7 web container within the service grid by deploying it as a processing unit. The integration is achieved by utilizing the <a href="http://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/catalina/startup/Embedded.html">Embedded Tomcat API</a>, which only requires a few lines of code to start an instance within a processing unit. This integration lets the end user enjoy all the useful features of Apache Tomcat, while leveraging the high availability and SLA monitoring of the XAP service grid.</p>
</td>

<td style="width:15%;"><p><img src="/attachment_files/logos/tomcat_logo.jpg" alt="tomcat_logo.jpeg" /></p>
</td>
</tr></table>

<p>The key features of the embedded Tomcat are:</p>

<ul>
<li>Auto-Scaling: Dynamic allocation and auto-scaling of Tomcat instances (hosting a web application) as well as automatically updating your load balancer through the Admin API</li>
<li>Simplified Management: Consolidated management of your web tier along with your data grid under one common administrative interface (through a web, desktop, and CLI administrative interface)</li>
<li>Fault Tolerance and Isolation: SLA enforcement through the Grid Service Manager by providing JVM-level, Machine-level, and Zone-level redundancy and failover upon deployment.</li>
<li>Low latency: Leverage colocation of Tomcat instances with space instances to avoid network round trips that access POJO from the data grid.</li>
</ul>

<h1><a name="deployment">&#160;</a>Deployment</h1>

<p>Embedding  Tomcat along with one or more associated web application is simply a matter of deploying a skeleton tomcat processing unit that contains both the Tomcat instantiation code as well as a your target web applications self-contained within the processing unit. This provides a clean way to deploy and undeploy the entire server instance along with its associated applications.</p>

<p>The tomcat processing unit hierarchy, once built with maven, will have the following structure:</p>

<p>Tomcat PU <br/>
|-   com  <br/>
|-   lib   <br/>
|-   META-INF <br/>
|-   webapps</p>

<table>
<thead>
<tr>
<th align="left">Folder</th>
<th align="left">Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">com</td>
<td align="left">Contains compiled code for instantiating Tomcat as well as utilizing server parameters</td>
</tr>

<tr>
<td align="left">lib</td>
<td align="left">Additional libraries required by Tomcat and web application</td>
</tr>

<tr>
<td align="left">META-INF</td>
<td align="left">Contains the PU.XML file for configuring Tomcat along with an optional SLA.XML file for configuring the processing unit SLA</td>
</tr>

<tr>
<td align="left">webapps</td>
<td align="left">A collection of web applications which will be loaded by Tomcat</td>
</tr>
</tbody>
</table>

<p>In order to deploy Tomcat along with your web application within XAP, the following steps must be followed:</p>

<p>Step 1: Download the tomcat-pu project from <a href="/download_files/sbp/tomcat-pu.tgz">here</a><br/>
Step 2: Configure the Tomcat instance through PU.XML to specify the container and application configuration</p>

<pre><code class="language-xml">&lt;bean id="tomcat7" class="com.gigaspaces.tomcat.Tomcat7"&gt;
  &lt;property name="appBase" value="/webapps" /&gt;
  &lt;property name="contextPath" value="/" /&gt;
  &lt;property name="port" value="8888" /&gt;
  &lt;property name="portRetries" value="10" /&gt;
  &lt;property name="webapps"&gt;
   &lt;array&gt;
    &lt;bean class="com.gigaspaces.tomcat.Webapp"&gt;
     &lt;property name="name" value="examples" /&gt;
     &lt;property name="path" value="/examples" /&gt;
    &lt;/bean&gt;
  &lt;/array&gt;
 &lt;/property&gt;
&lt;/bean&gt;
</code></pre>

<table>
<thead>
<tr>
<th align="left">Property</th>
<th align="left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">appBase</td>
<td align="left">Location in the project of web applications</td>
</tr>

<tr>
<td align="left">contextPath</td>
<td align="left">Root context path for applications</td>
</tr>

<tr>
<td align="left">port</td>
<td align="left">Starting port number when deploying multiple instances</td>
</tr>

<tr>
<td align="left">portRetries</td>
<td align="left">How many ports to try before giving up</td>
</tr>

<tr>
<td align="left">webapps</td>
<td align="left">The collection of web applications contained in the processing unit.</td>
</tr>
</tbody>
</table>

<p>Step 3: Place your web applications in src/main/resources/webapps <br/>
Step 4: (optional) Specify the SLA parameters for fault isolation and redundancy through an SLA.XML file in META-INF/spring</p>

<table>
<thead>
<tr>
<th align="left">Setting</th>
<th align="left">SLA Directive</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Maximum of one Tomcat instance per JVM</td>
<td align="left"><code>&lt;os-sla:sla max-instances-per-vm="1" /&gt;</code></td>
</tr>

<tr>
<td align="left">Maximum of one Tomcat instance per physical machine</td>
<td align="left"><code>&lt;os-sla:sla max-instances-per-machine="1" /&gt;</code></td>
</tr>

<tr>
<td align="left">Maximum of one Tomcat instance per zone (sets of machines or availability zone)</td>
<td align="left"><code>&lt;os-sla:sla max-instances-per-zone="1" /&gt;</code></td>
</tr>
</tbody>
</table>

<p>Step 5: Build the project through mvn package <br/>
Step 6: Deploy processing unit in XAP, once deployed Tomcat should appear as the following</p>

<div class="tc-align-center"><p><img src="/attachment_files/sbp/tomcat1.png" alt="tomcat1.png" /></p>
</div>

<p>Navigate to (default) port 8888 to test</p>

<div class="tc-align-center"><p><img src="/attachment_files/sbp/tomcat2.png" alt="tomcat2.png" /></p>
</div>

<p>Step 7: Increase or decrease instances of Tomcat running through the “Deployed Processing Units” tab</p>

<div class="tc-align-center"><p><img src="/attachment_files/sbp/tomcat3.png" alt="tomcat3.png" /></p>
</div>

<p>With the default project, upon adding new instances on your local machine, the next one should be listening on port 8889.</p>

<h1><a name="class-loading">&#160;</a>Class Loading</h1>

<p>The following describes the structure of the class loaders when several web applications are deployed on the Service Grid:</p>

<pre><code>     Bootstrap (Java)
              |
           System (Java)
              |
           Common (Service Grid)
              |
        Tomcat 7 Container (Tomcat)
         /        \
    WebApp1     WebApp2
</code></pre>

<p>The following table shows which user controlled locations end up in which class loader, and the important JAR files that exist within each one:</p>

<table>
<thead>
<tr>
<th align="left">Class Loader</th>
<th align="left">User Locations</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Common</td>
<td align="left">[GSRoot]/lib/platform/ext/*.jar</td>
</tr>

<tr>
<td align="left">Tomcat 7</td>
<td align="left">[PU]/lib, [PU]/com/*</td>
</tr>

<tr>
<td align="left">Webapp</td>
<td align="left">[PU]/webapps/WEB-INF/classes, [PU]/webapps/WEB-INF/lib/*.jar</td>
</tr>
</tbody>
</table>

<h1><a name="tomcat-cluster-with-a-data-grid-deployment">&#160;</a>Tomcat Cluster with a Data Grid Deployment</h1>

<p>See below for different options deploying Tomcat cluster with an embedded data grid or Tomcat cluster using a local cache with Remote data grid:</p>

<h2><a name="deploying-two-nodes-tomcat-cluster-with-an-embedded-sync-replicated-data-grid">&#160;</a>Deploying Two nodes Tomcat Cluster with an Embedded Sync-replicated Data-Grid</h2>

<div class="tc-align-center"><p><a href="/attachment_files/sbp/tomcat-deploy1.png"><img src="/attachment_files/sbp/tomcat-deploy1.png" width="500" height="350"></a></p>
</div>

<p>The <code>pu.xml</code> should include:</p>

<pre><code class="language-xml">&lt;beans 
    &lt;bean id="tomcat7" class="com.gigaspaces.tomcat.Tomcat7"&gt;
....
    &lt;os-core:embedded-space id="space" name="space" /&gt;
&lt;/beans&gt;
</code></pre>

<p>Tomcat Cluster with two instances embedded sync-replicated data-grid deploy command:</p>

<pre><code class="language-xml">gs deploy -cluster schema=sync_replicated total_members=2 tomcat-pu-1.0-SNAPSHOT.jar
</code></pre>

<h2><a name="deploying-two-nodes-tomcat-cluster-with-an-embedded-async-replicated-data-grid">&#160;</a>Deploying Two nodes Tomcat Cluster with an Embedded ASync-replicated Data-Grid</h2>

<p>The <code>pu.xml</code> should include:</p>

<pre><code class="language-xml">&lt;beans 
    &lt;bean id="tomcat7" class="com.gigaspaces.tomcat.Tomcat7"&gt;
....
    &lt;os-core:embedded-space id="space" name="space" /&gt;
&lt;/beans&gt;
</code></pre>

<p>Tomcat Cluster with two instances embedded async-replicated data-grid deploy command:</p>

<pre><code class="language-xml">gs deploy -cluster schema=async_replicated total_members=2 tomcat-pu-1.0-SNAPSHOT.jar
</code></pre>

<h2><a name="deploying-two-nodes-tomcat-cluster-with-a-local-cache-communicating-with-a-remote-data-grid">&#160;</a>Deploying Two nodes Tomcat Cluster with a Local-cache Communicating with a Remote Data-Grid</h2>

<div class="tc-align-center"><p><a href="/attachment_files/sbp/tomcat-deploy2.png"><img src="/attachment_files/sbp/tomcat-deploy2.png" width="500" height="400"></a></p>
</div>

<p>The <code>pu.xml</code> should include:</p>

<pre><code class="language-xml">&lt;beans 
    &lt;bean id="tomcat7" class="com.gigaspaces.tomcat.Tomcat7"&gt;
....
    &lt;os-core:space-proxy id="space" name="space" /&gt;
    &lt;os-core:local-cache id="localCacheSpace" space="space"&gt;
        &lt;os-core:properties&gt;
        &lt;props&gt;
            &lt;prop key="space-config.engine.cache_size"&gt;5000000&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.high_watermark_percentage"&gt;75&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.write_only_block_percentage"&gt;73&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.write_only_check_percentage"&gt;71&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.low_watermark_percentage"&gt;50&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.eviction_batch_size"&gt;1000&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.retry_count"&gt;20&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.explicit"&gt;false&lt;/prop&gt;
            &lt;prop key="space-config.engine.memory_usage.retry_yield_time"&gt;200&lt;/prop&gt;
        &lt;/props&gt;
        &lt;/os-core:properties&gt;
    &lt;/os-core:local-cache&gt;

    &lt;os-core:giga-space id="localCache" space="localCacheSpace"/&gt;
&lt;/beans&gt;
</code></pre>

<p>Data Grid (Two partitions with a sync-replicated backup) deploy command:</p>

<pre><code class="language-xml">gs deploy-space -cluster schema=partitioned-sync2backup total_members=2,1 space
</code></pre>

<p>Tomcat Cluster deploy command:</p>

<pre><code class="language-xml">gs deploy -cluster total_members=2 tomcat-pu-1.0-SNAPSHOT.jar
</code></pre>

<h1><a name="elastic-load-balancer">&#160;</a>Elastic Load Balancer</h1>

<p>Implementing automatic updates of load balancer tables can be done through the combination of the Admin API for monitoring the processing unit instances. A similar pattern is available through the <a href="web-load-balancer-agent-pu.html">Apache Load Balancer processing unit</a>.</p>

</body>
</html>