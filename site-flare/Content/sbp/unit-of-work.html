<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
<head></head>
<body>
<h1>Unit Of Work</h1>
  

<table>
<thead>
<tr>
<th>Author</th>
<th>XAP Version</th>
<th>Last Updated</th>
<th>Reference</th>
<th>Download</th>
</tr>
</thead>

<tbody>
<tr>
<td>Shay Hassidim</td>
<td>8.0</td>
<td>Feb 2011</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h1><a name="overview">&#160;</a>Overview</h1>

<p>The Unit of work Pattern - Parallel atomic ordered data processing for associated data objects</p>

<h1><a name="gigaspaces-unit-of-work">&#160;</a>GigaSpaces Unit of Work</h1>

<p>GigaSpaces Unit of Work (UOW) enables a stand-alone message producer to group messages into a single unit such that those messages can be handled in order - similar to a FIFO queue localized within a transaction. This single unit is called a Unit-of-work and requires that all messages from that unit be processed <span class="tc-bold">sequentially in the order</span> they were created (within the unit of work). Other units can be processes in parallel. This approach maximize the system performance and its scalability and allows it to processes vast amount of data consuming memory and CPU resources in a very optimal manner.</p>

<p>The UOW can be used with financial systems to process <span class="tc-bold">trade orders</span> , in healthcare systems to processes <span class="tc-bold">patient medical data</span> , with transportation systems to process <span class="tc-bold">reservations</span> , with airlines systems to process <span class="tc-bold">flight schedule</span> , with billing system to processes <span class="tc-bold">payments</span>, etc.</p>

<div class="tc-admon-tip">
  
  <p>Starting with XAP 9 you may use the <span class="tc-bold">FIFO Grouping</span> to implement the Unit of Work model. See the <a href="/xap/14.0/dev-java/fifo-grouping.html">FIFO Grouping</a> for details.</p>
</div>

<h1><a name="gigaspaces-fifo-and-uow">&#160;</a>GigaSpaces FIFO and UOW</h1>

<p>While the <a href="/xap/14.0/dev-java/fifo-support.html">FIFO</a> mode provides ordered object consumption, it does so in a very strict sense. It defines an order between space objects based on the time they were written into the space. FIFO does not take into account consuming associated objects as one atomic operation. UOW allows a polling container to process a group of associated objects in the order they have been written in parallel to other processing groups. Multiple polling containers handle different groups concurrently, each group items processed in a FIFO fashion.</p>

<h1><a name="when-can-the-gigaspaces-unit-of-work-be-used">&#160;</a>When can the GigaSpaces Unit of Work be used?</h1>

<p>GigaSpaces UOW can be used in the following cases:</p>

<ul>
<li>When having <span class="tc-bold">many consumers</span>, each should handle a different group (number of groups may be unlimited) where the processing of the items within the group should be done in an ordered fashion as <span class="tc-bold">one atomic operation</span>.</li>
<li>When having <span class="tc-bold">multiple producers</span>, where data from each producer may be associated with different groups (number of groups may be unlimited) where the processing of the items within the group should be done in an ordered fashion as <span class="tc-bold">one atomic operation</span>.</li>
</ul>

<h1><a name="example-use-case">&#160;</a>Example use case</h1>

<p>Here is a simple scenario illustrates the Unit of Work usage:</p>

<ol>
<li>Client A starts an Order ID 1 and submits a request to buy $1000 worth of shares of IBM</li>
<li>Client A starts an Order ID 2 and submits a request to buy $1000 worth of shares of MSFT</li>
<li>Client A resumes Order ID 1 and submits a request to increase the purchase of IBM request by $500</li>
<li>Client A resumes Order ID 1 and submits a request to cancel the purchase of IBM shares</li>
<li>Client A cancels Order ID 2</li>
</ol>

<p>With the above scenario requests 1, 3 and 4 should be processed as one atomic operation where requests 2 and 5 can be processed in parallel but also as one atomic operation.</p>

<h1><a name="how-is-the-gigaspaces-unit-of-work-configured">&#160;</a>How is the GigaSpaces Unit of Work configured?</h1>

<ul>
<li>Multiple polling containers running in the following mode are started:
– Using <code>SingleTakeReceiveOperationHandler</code>.
– Using one concurrent consumer thread.
– Consumed objects in a FIFO mode.
– Template set with a different <code>bucketId</code> for each polling container - This ensures <span class="tc-bold">no contention</span> or <span class="tc-bold">race conditions</span> will be generated.
– Using Local Transaction Manager.</li>
<li>The polling container <code>SpaceDataEvent</code> implementation flow:
    1. Transaction started and an object at the top of the FIFO chain is taken.
    2. To consume the entire group, a <code>takeMultiple</code> is called using a template with the group identity set. The objects are retrieved in FIFO fashion (in order).
    3. Group is processed.
    4. Transaction is committed.
    5. Other groups are processes in-parallel by other polling containers.</li>
</ul>

<div class="tc-align-center"><p><img src="/attachment_files/sbp/uow_1.jpg" alt="uow_1.jpg" /></p>
</div>

<h1><a name="uow-example">&#160;</a>UOW Example</h1>

<h2><a name="running-the-example">&#160;</a>Running the Example</h2>

<div class="tc-admon-tip">
  
  <p>You can <a href="/attachment_files/sbp/uow.zip">download</a> eclipse project with example source code, running scripts and configuration.</p>
</div>

<div class="easyui-tabs" plain="true" data-options=""><div title="  Running the UOWProcessor within your IDE " style="padding:10px"><p>You can run the UOW Data-Grid with the collocated <code>UOWProcessor</code> within your IDE using the following configuration:</p>

<div class="tc-align-center"><p><img src="/attachment_files/sbp/uow_3.jpg" alt="uow_3.jpg" /></p>
</div>

<p>Here is a configuration for a UOW Data-Grid with 2 partitions:</p>

<div class="tc-align-center"><p><img src="/attachment_files/sbp/uow_2.jpg" alt="uow_2.jpg" /></p>
</div>
</div>

<div title="  Deploying the UOWProcessor into the Service Grid " style="padding:10px"><p>Instead of running the UOWProcessor within your IDE, you can deploy it into the Service Grid.</p>

<ol>
<li>Edit the <code>setExampleEnv.bat</code> to include correct values for the <code>NIC_ADDR</code> variable as your machine IP and the <code>GS_HOME</code> variable as the GigaSpaces root folder.</li>
<li>Start the Service-Grid</li>
</ol>

<pre><code class="language-java">runAgent.bat
</code></pre>

<ol>
<li>Deploy the UOWProcessor PU</li>
</ol>

<pre><code class="language-java">deployUOW.bat
</code></pre>

<p>This will deploy the UOW Data-Grid with 2 partitions and a backup.</p>
</div>

<div title="  Running the UOWFeeder " style="padding:10px"><p>You can run the <code>UOWFeeder</code> within your IDE using the following configuration:</p>

<div class="tc-align-center"><p><img src="/attachment_files/sbp/uow_4.jpg" alt="uow_4.jpg" /></p>
</div>

<p>or using the following:</p>

<p><pre><code class="language-java">runClient.bat
</code></pre>
</div>
</div>

<h2><a name="example-code-and-configuration">&#160;</a>Example Code and Configuration</h2>

<div class="tc-admon-tip">
  
  <p>The bucket count configured via the UOW Data-Grid pu.xml using the BucketConfiguration Bean</p>
</div>

<div class="easyui-tabs" plain="true" data-options=""><div title="  The UOWMessage Class " style="padding:10px"><pre><code class="language-java">package com.giagspaces.patterns.uow;

@SpaceClass(fifoSupport = FifoSupport.ALL)
public class UOWMessage {

    private Integer id;
    private String data;
    private String group;
    private Integer buketId;

    public UOWMessage() {
    }

    @SpaceId
    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getData() {
        return data;
    }

    public void setData(String data) {
        this.data = data;
    }

    @SpaceIndex(type = SpaceIndexType.BASIC)
    @SpaceRouting
    public String getGroup() {
        return group;
    }

    public void setGroup(String subject) {
        this.group = subject;
    }

    public Integer getBuketId() {
        return buketId;
    }

    @SpaceIndex(type = SpaceIndexType.BASIC)
    public void setBuketId(Integer buketId) {
        this.buketId = buketId;
    }
}
</code></pre>
</div>

<div title="  The UOWFeeder " style="padding:10px"><p>The <code>buketId</code> is calculated using the following:</p>

<pre><code class="language-java">group % bucketsCount
</code></pre>

<pre><code class="language-java">package com.giagspaces.patterns.uow;
public class UOWFeederMain {

    static String locators = System.getProperty("locators", "127.0.0.1");
    static String groups = System.getProperty("groups", "gigaspaces-8.0.3-XAPPremium-ga");

    public static void main(String[] args) throws Exception {
        int burstSize = 100;
        int iterations = 20;
        int groupsCount = 20;

        if (args.length &gt; 0) {
            burstSize = Integer.valueOf(args[0]).intValue();
        }

        GigaSpace space = new GigaSpaceConfigurer(new UrlSpaceConfigurer(
                "jini://*/*/space").lookupGroups(groups).lookupLocators(locators)).gigaSpace();

        UOWProcessorService uowService = new ExecutorRemotingProxyConfigurer&lt;UOWProcessorService&gt;(
                space, UOWProcessorService.class).proxy();

        int bucketsCount = uowService.getBucketsCount();
        System.out.println("There are "+ bucketsCount+ " buckets with "+groupsCount + " groups");

        int i = 0;

        UOWMessage messageArry[] = new UOWMessage[burstSize];
        for (int count = 0; count &lt; iterations; count++) {
            for (int j = 0; j &lt; burstSize; j++) {
                UOWMessage m = new UOWMessage();
                m.setData("AA");
                m.setId(i);
                int group = i % groupsCount;
                m.setGroup(group + "");
                m.setBuketId(group % bucketsCount);
                messageArry[j] = m;
                i++;
            }
            space.writeMultiple(messageArry);
            System.out.println("Feeder wrote " + burstSize + " objects:"+ (i-burstSize) + "-"+ (i-1));
            try {
                Thread.sleep(500);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
</div>

<div title="  The UOWProcessorService " style="padding:10px"><pre><code class="language-java">package com.giagspaces.patterns.uow;

public interface UOWProcessorService {
    int getBucketsCount();
}
</code></pre>
</div>

<div title="  The UOWProcessor " style="padding:10px"><pre><code class="language-java">package com.giagspaces.patterns.uow;
public class UOWProcessor {
    int bucketID;
    int partitionID;

    public UOWProcessor(int _bucketID , int _partitionID) {
        this.bucketID = _bucketID;
        this.partitionID = _partitionID;
    }

    @ExceptionHandler
    public EventExceptionHandler exceptionHandler() {
        return new EventExceptionHandler() {

            @Override
            public void onException(ListenerExecutionFailedException exception,
                    Object data, GigaSpace gigaSpace,
                    TransactionStatus txStatus, Object source)
                    throws RuntimeException {
                System.out.println(exception);
                throw exception;
            }

            @Override
            public void onSuccess(Object data, GigaSpace gigaSpace,
                    TransactionStatus txStatus, Object source)
                    throws RuntimeException {
            }
        };
    }

    @SpaceDataEvent
    public void eventListener(UOWMessage message, GigaSpace space,
            TransactionStatus txStatus) {
        UOWMessage associatedMessagesTemplate = new UOWMessage();
        associatedMessagesTemplate.setGroup(message.getGroup());

        // consume associated Messages
        UOWMessage associatedMessages[] = space.takeMultiple(
                associatedMessagesTemplate, 1000);
        if (associatedMessages.length == 0) {
            System.out.println("No associated messages to process.");
        }

        // Consume the incoming message + associatedMessages
        StringBuffer buf = new StringBuffer("Consumed:Group ").append(
                message.getGroup()).append(" :").append(" ").append(
                message.getId()).append(" ");

        // check if really FIFO
        if (associatedMessages.length != 1) {
            for (int i = 0; i &lt; associatedMessages.length; i++) {
                buf.append(associatedMessages[i].getId()).append(" ");

                // not end of the array
                if (i != associatedMessages.length - 1) {
                    if (associatedMessages[i + 1].getId()
                            - associatedMessages[i].getId() != 20) {
                        System.err.println("Error IN FIFO!!! Group "
                                + associatedMessages[i].getGroup()
                                + " Current:"
                                + associatedMessages[i + 1].getId() + " Prev:"
                                + associatedMessages[i].getId());
                        // Something is wrong - rollback
                        txStatus.setRollbackOnly();
                        return;

                    }
                }
            }
        }

        // Simulate processing time
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

        System.out.println("Partition ID:" + partitionID + " TID:" + Thread.currentThread().getId() + " bucket ID:"+ bucketID + " " + buf.toString());
    }
}
</code></pre>
</div>

<div title="  The UOWProcessorFactory " style="padding:10px"><pre><code class="language-java">@RemotingService
public class UOWProcessorFactory implements UOWProcessorService{

    @Autowired
    @Resource(name = "bucketConfiguration")
    BucketConfiguration bucketConfig = new BucketConfiguration ();

    @GigaSpaceContext
    GigaSpace space;

    @Autowired
    @Resource(name = "transactionManager")
    PlatformTransactionManager transactionManager;

    @ClusterInfoContext
    ClusterInfo clusterInfo;

    int partitionID = 1;

    List&lt;SimplePollingEventListenerContainer&gt; pcList = new LinkedList&lt;SimplePollingEventListenerContainer&gt;();

    void createProcessor(int bucket) {
        System.out.println("&gt;&gt;&gt;&gt;&gt; starting polling container for bucket #" + bucket);
        UOWMessage templ = new UOWMessage();
        templ.setBuketId(bucket);

        SimplePollingEventListenerContainer pc = new SimplePollingContainerConfigurer(space)
            .eventListenerAnnotation(new UOWProcessor(bucket,partitionID))
            .transactionManager(transactionManager).template(templ)
            .pollingContainer();

        pcList.add(pc);
    }

    @PostPrimary
    public void init() throws Exception {
        if (clusterInfo!=null) partitionID=clusterInfo.getInstanceId();
        System.out.println("&gt;&gt;&gt;&gt;&gt; Partition ID:"+ partitionID + " - starting "+ bucketConfig.getBucketsCount() + " polling containers &lt;&lt;&lt;&lt;&lt;&lt;");
        for (int i = 0; i &lt; bucketConfig.getBucketsCount(); i++) {
            createProcessor(i);
        }
    }

    @PreDestroy
    public void shutdown() {
        for (SimplePollingEventListenerContainer simplePollingEventListenerContainer : pcList) {
            simplePollingEventListenerContainer.shutdown();
        }
    }

    public int getBucketsCount() {
        return bucketConfig.getBucketsCount();
    }
}
</code></pre>
</div>

<div title="  The UOW Data-Grid pu.xml  " style="padding:10px"><pre><code class="language-java">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:context="http://www.springframework.org/schema/context"
      xmlns:os-core="http://www.openspaces.org/schema/core"
      xmlns:os-events="http://www.openspaces.org/schema/events"
      xmlns:tx="http://www.springframework.org/schema/tx"
      xmlns:os-remoting="http://www.openspaces.org/schema/remoting"
      xmlns:os-sla="http://www.openspaces.org/schema/sla"
      xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
      http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
      http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd
      http://www.openspaces.org/schema/core http://www.openspaces.org/schema/core/openspaces-core.xsd
      http://www.openspaces.org/schema/events http://www.openspaces.org/schema/events/openspaces-events.xsd
      http://www.openspaces.org/schema/remoting http://www.openspaces.org/schema/remoting/openspaces-remoting.xsd
      http://www.openspaces.org/schema/sla http://www.openspaces.org/schema/sla/openspaces-sla.xsd"&gt;

    &lt;os-core:annotation-support /&gt;

    &lt;bean id="bucketConfiguration" class="com.giagspaces.patterns.uow.BucketConfiguration" &gt;
         &lt;property name="bucketsCount"&gt; &lt;value&gt;8&lt;/value&gt;  &lt;/property&gt;
    &lt;/bean&gt;

    &lt;context:component-scan base-package="com.giagspaces.patterns.uow"/&gt;
    &lt;os-remoting:annotation-support /&gt;
    &lt;tx:annotation-driven transaction-manager="transactionManager"/&gt;
    &lt;os-core:giga-space-context/&gt;
    &lt;os-events:annotation-support /&gt;
    &lt;os-core:embedded-space id="space" name="space"/&gt;
    &lt;os-core:local-tx-manager id="transactionManager" space="space" default-timeout="5000" /&gt;
    &lt;os-core:giga-space id="gigaSpace" space="space" tx-manager="transactionManager"/&gt;
    &lt;os-remoting:service-exporter id="serviceExporter" /&gt;

&lt;/beans&gt;
</code></pre>
</div>

<div title="  The BucketConfiguration " style="padding:10px"><pre><code class="language-java">package com.giagspaces.patterns.uow;

public class BucketConfiguration {
    int bucketsCount = 4;

    public int getBucketsCount() {
        return bucketsCount;
    }

    public void setBucketsCount(int bucketsCount) {
        this.bucketsCount = bucketsCount;
    }
}
</code></pre>
</div>
</div>

</body>
</html>