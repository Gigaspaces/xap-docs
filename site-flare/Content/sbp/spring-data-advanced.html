<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
<head></head>
<body>
<h1>Advanced Usage</h1>
  

<p>This section describes some of the more advanced features available through XAP Spring Data.</p>

<h1><a name="projection-api">&#160;</a>Projection API</h1>

<p>The Spring Data XAP supports <a href="/xap/14.0/dev-java/query-partial-results.html">XAP Projection</a> which allows to read only certain properties for the objects (delta read). This approach reduces network overhead,   memory consumption    and CPU overhead due to decreased serialization time.</p>

<p>The <code>XapRepository</code> interface provides you with basic <code>find</code> methods extended with the <code>Projection</code> argument. The example demonstrates how the <code>findOne</code> method can be used to select only <code>name</code> field from <code>Person</code>:</p>

<pre><code class="language-java">@Service
public class PersonServiceImpl implements PersonService {
    @Autowired
    private PersonRepository repository;

    public List&lt;String&gt; getAllNames() {
        Iterable&lt;Person&gt; personList = repository.findAll(Projection.projections("name"));
        // result processing ommited
    }

}
</code></pre>

<div class="tc-admon-note">
  
  <p>If you are using <a href="#querydsl">Querydsl support</a>, you can apply projection using <code>QueryDslProjection</code>. This approach will let you avoid run-time errors when the POJO field is renamed and projection fields are not since they are just strings.</p>
</div>

<p>You can also supply your query methods with <code>Projection</code>, just add an additional argument to the method declaration:</p>

<pre><code class="language-java">public interface PersonRepository extends XapRepository&lt;Person, String&gt; {

    List&lt;Person&gt; findByName(String name, Projection projection);

}
</code></pre>

<div class="tc-admon-refer">
  
  <p>To read more on projection refer to <a href="/xap/14.0/dev-java/query-partial-results.html">Projection</a> reference.</p>
</div>

 <a name="querydsl">&#160;</a>

<h1><a name="querydsl-support">&#160;</a>Querydsl Support</h1>

<p>The <code>Querydsl</code> framework let's you write type-safe queries in Java instead of using  query strings. It gives you several advantages: code completion in your IDE, domain types and properties can be accessed in a type-safe manner which reduces the probability of query syntax errors during run-time. If you want to read more about <code>Querydsl</code>, please, proceed to <a href="http://www.querydsl.com/">Querydsl website</a>.</p>

<p>Several steps are needed to start using XAP Repositories <code>Querydsl</code> support. First, use the repository as a <code>XapQueryDslPredicateExecutor</code> along with <code>XapRepository</code>:</p>

<pre><code class="language-java">public interface PersonRepository extends XapRepository&lt;Person, String&gt;, XapQueryDslPredicateExecutor&lt;Person&gt; {
}
</code></pre>

<div class="tc-admon-note">
  
  <p>Note that you define the type of data to be accessed with Querydsl.</p>
</div>

<p>Then, add the source processor to your maven build (<code>pom.xml</code>) using Maven Annotation Processing Tool plugin:</p>

<pre><code class="language-xml">&lt;project&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      ...
      &lt;plugin&gt;
        &lt;groupId&gt;com.mysema.maven&lt;/groupId&gt;
        &lt;artifactId&gt;apt-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.1.3&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;process&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
              &lt;outputDirectory&gt;target/generated-sources/java&lt;/outputDirectory&gt;
              &lt;processor&gt;org.springframework.data.xap.querydsl.XapQueryDslAnnotationProcessor&lt;/processor&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      ...
    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;
</code></pre>

<p>This configuration will call <code>XapQueryDslAnnotationProcessor</code> before compiling your project sources. It will look for POJOs marked with <code>@SpaceClass</code> annotation and generate <code>Q...</code> classes for them that allow you to build up Querydsl <code>Predicate</code>s. Before using such classes, you have to call this processor with <code>process-sources</code> maven goal, or just call <code>install</code> if you are already using it:</p>

<pre><code class="language-bash">mvn clean process-sources
mvn clean install
</code></pre>

<p>Now you can query your repository using Querydsl <code>Predicate</code>s:</p>

<pre><code class="language-java">@Service
public class PersonServiceImpl implements PersonService {
    @Autowired
    private PersonRepository repository;

    public Iterable&lt;Person&gt; getByAge(Integer minAge, Integer maxAge) {
        return repository.findAll(
                QPerson.person.name.isNotNull().and(QPerson.person.age.between(minAge, maxAge))
        );
    }

}
</code></pre>

<p>A full list of supported <code>Predicate</code> methods can be found in <a href="spring-data-appendix.html#appendix-b">Appendix B</a>.</p>

<h1><a name="change-api">&#160;</a>Change API</h1>

<p>The Spring Data XAP supports <a href="/xap/14.0/dev-java/change-api.html">XAP Change API</a> allowing to update existing objects in Space by specifying only the required change instead of passing the entire updated object. It reduces network traffic between the client and the Space. It also can prevent the need of reading the existing object prior to the change operation because the change operation can specify how to change the existing property without knowing its current value.</p>

<p>There are two possible ways you can use Change API within the Xap Repositories. The first option is to call the native Change API by accessing <code>space()</code> in <code>XapRepository</code>.
For that, the <code>GigaSpace.change</code> methods along with <code>ChangeSet</code> class can be used.</p>

<div class="tc-admon-refer">
  
  <p>Full explanation and code examples can be found at <a href="/xap/14.0/dev-java/change-api.html">Change API</a>.</p>
</div>

<p>The second option would be to use <code>XapQueryDslPredicateExecutor.change</code> method built in <code>Querydsl</code> style. It accepts <code>QChangeSet</code> argument that is literally a <code>ChangeSet</code> with <code>Querydsl</code> syntax:</p>

<pre><code class="language-java">@Service
public class PersonServiceImpl implements PersonService {
    @Autowired
    private PersonRepository repository;

    public void increaseAgeByName(String name) {
        repository.change(
                QPerson.person.name.eq(name),
                QChangeSet.changeSet().increment(QPerson.person.age, 1)
        );
    }

}
</code></pre>

<div class="tc-admon-refer">
  
  <p>To start using Querydsl Change API syntax, refer to <a href="#querydsl">Querydsl Support</a></p>
</div>

<p>The full list of supported change methods can be found in <a href="spring-data-appendix.html#appendix-c">Appendix C</a>.</p>

<h1><a name="take-operations">&#160;</a>Take Operations</h1>

<p>The Spring Data XAP supports take operations that are the same as querying the space, but returned objects are deleted from the storage. This approach removes the need to perform additional operations when you implement a pattern where consumers or workers are receiving tasks or messages.</p>

<p>Basic take operation can be performed by object ids with <code>take(...)</code> methods in <code>XapRepository</code> interface. More advanced querying is available in Querydsl style within <code>XapQueryDslPredicateExecutor</code> interface. Those accept <code>Predicate</code> to retrieve one or multiple objects that match the query:</p>

<pre><code class="language-java">@Service
public class PersonServiceImpl implements PersonService {
    @Autowired
    private PersonRepository repository;

    public Person takeByName(String name) {
        return repository.takeOne(QPerson.person.name.eq(name));
    }

}
</code></pre>

<h1><a name="lease-time">&#160;</a>Lease Time</h1>

<p>Spring XAP Data comes with a support of defining lease time for new objects in the repository. The basic idea behind it is limiting the time an object lives in Space. To use this feature, you can specify the lease time (in any time units) when saving with <code>save(...)</code> methods. These overloaded methods will return a special <code>LeaseContext</code> object that allows you to track, renew and cancel the lease.</p>

<p>The essential idea behind a lease is fairly simple.
* When creating a resource, the requestor creates the resource with a limited life span.
* The grantor of the resource will then give access for some period of time that is no longer than that requested.
* The period of time that is actually granted is returned to the requestor as part of the Lease object.
* A holder of a lease can request that a Lease be renewed, or cancel the Lease at any time.
* Successfully renewing a lease extends the time period during which the lease is in effect.
* Cancelling the lease drops the lease immediately.</p>

<div class="tc-admon-refer">
  
  <p>To read more about this feature refer to <a href="/xap/14.0/dev-java/leases-automatic-expiration.html">Lease Time</a>.</p>
</div>

<h1><a name="transactions">&#160;</a>Transactions</h1>

<p>Spring Data XAP comes with a support of declarative Spring transactions based on <code>OpenSpaces</code> transaction managers. In order to apply transactional behaviour, the transaction manager must be provided as a reference when constructing the <code>GigaSpace</code> bean. For example (using the distributed transaction manager):</p>

<pre><code class="language-xml">&lt;beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:xap-data="http://www.springframework.org/schema/data/xap"
       xmlns:os-core="http://www.openspaces.org/schema/core"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns="http://www.springframework.org/schema/beans"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
        http://www.springframework.org/schema/data/xap http://www.springframework.org/schema/data/xap/spring-xap-1.0.xsd
        http://www.openspaces.org/schema/core http://www.openspaces.org/schema/10.1/core/openspaces-core.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-3.0.xsd"&gt;

  &lt;xap-data:repositories base-package="com.yourcompany.foo.bar"/&gt;

  &lt;!-- Enables the detection on @Transactional annotations --&gt;
  &lt;tx:annotation-driven transaction-manager="transactionManager"/&gt;

  &lt;!-- Space declaration, nothing transaction-special here --&gt;
  &lt;os-core:space-proxy id="space" name="space"/&gt;

  &lt;!-- GigaSpace bean with provided transaction manager --&gt;
  &lt;os-core:giga-space id="gigaSpace" space="space" tx-manager="transactionManager"/&gt;

  &lt;!-- OpenSpaces distributed transaction manager --&gt;
  &lt;os-core:distributed-tx-manager id="transactionManager"/&gt;

&lt;/beans&gt;
</code></pre>

<p>Now your service layer methods can be marked as <code>@Transactional</code>:</p>

<pre><code class="language-java">@Service
public class PersonServiceImpl implements PersonService {

    @Autowired
    private PersonRepository personRepository;

    @Transactional
    public void transactionalMethod(Person person) {
        ...
    }

}
</code></pre>

<div class="tc-admon-refer">
  
  <p>To read more about transaction support  refer to <a href="/xap/14.0/dev-java/transaction-overview.html">Transactions Reference</a>.</p>
</div>

<h1><a name="document-storage-support">&#160;</a>Document Storage Support</h1>

<p>The <a href="/xap/14.0/dev-java/document-api.html">XAP Document API</a> exposes the Space as Document Store. A document, which is represented by the class <code>SpaceDocument</code>, is a collection of key-value pairs, where the keys are strings and the values are primitives, <code>String</code>, <code>Date</code>, other documents, or collections thereof. Most importantly, the Space is aware of the internal structure of a document, and thus can index document properties at any nesting level and expose rich query semantics for retrieving documents.</p>

<p>While using Spring Data XAP you can declare one or more of your repositories to be a Document Repository. To do so, first, you have to add a schema definition of the document type into the Space configuration in context:</p>

<pre><code class="language-xml">&lt;os-core:embedded-space id="space" name="space"&gt;

  &lt;os-core:space-type type-name="Person"&gt;
    &lt;os-core:id property="id"/&gt;
    &lt;os-core:routing property="age"/&gt;
    &lt;os-core:basic-index path="name"/&gt;
    &lt;os-core:extended-index path="birthday"/&gt;
  &lt;/os-core:space-type&gt;

  &lt;!-- other document types declarations --&gt;

&lt;/os-core:embedded-space&gt;
</code></pre>

<p>Then, extend <code>XapDocumentRepository</code> interface (instead of usual <code>XapRepository</code>) and annotate it with <code>@SpaceDocumentName</code> to wire it to document descriptor declared above:</p>

<pre><code class="language-java">@SpaceDocumentName("Person")
public interface PersonDocumentRepository extends XapDocumentRepository&lt;SpaceDocument, String&gt; {
}
</code></pre>

<div class="tc-admon-note">
  
  <p>If you don't mark your Document Repository with <code>@SpaceDocumentName</code> annotation, context configuration will fail.</p>
</div>

<p>Now <code>PersonDocumentRepository</code> will have basic CRUD operations available for <code>SpaceDocument</code> entities. To read more on available document storage features, refer to <a href="/xap/14.0/dev-java/document-api.html">Document API</a>.</p>

<p>While documents allow using a dynamic schema, they force us to give up Java's type-safety for working with type less key-value pairs. Spring Data XAP supports extending the <code>SpaceDocument</code> class to provide a type-safe wrapper for documents which is much easier to code with, while maintaining the dynamic schema. As an example, let's declare a <code>PersonDocument</code> wrapper:</p>

<pre><code class="language-java">public class PersonDocument extends SpaceDocument {
    public static final String TYPE_NAME = "Person";
    public static final String PROPERTY_ID = "id";
    public static final String PROPERTY_AGE = "age";
    // other properties omitted

    public PersonDocument() {
        super(TYPE_NAME);
    }

    public String getId() {
        return super.getProperty(PROPERTY_ID);
    }

    public PersonDocument setId(String id) {
        super.setProperty(PROPERTY_ID, id);
        return this;
    }

    public Integer getAge() {
        return super.getProperty(PROPERTY_AGE);
    }

    public PersonDocument setAge(Integer age) {
        super.setProperty(PROPERTY_AGE, age);
        return this;
    }

    // other properties accessors are omitted
}
</code></pre>

<div class="tc-admon-note">
  
  <p>Note that wrapper classes must have a parameter less constructor</p>
</div>

<p>To work with objects of a <code>PersonDocument</code> class instead of <code>SpaceDocument</code>, Space configuration must contain the declaration of the wrapper class:</p>

<pre><code class="language-xml">&lt;os-core:embedded-space id="space" name="space"&gt;

  &lt;os-core:space-type type-name="Person"&gt;
    &lt;os-core:id property="id"/&gt;
    &lt;os-core:routing property="age"/&gt;
    &lt;os-core:basic-index path="name"/&gt;
    &lt;os-core:extended-index path="birthday"/&gt;
    &lt;os-core:document-class&gt;com.yourcompany.foo.bar.PersonDocument&lt;/os-core:document-class&gt;
  &lt;/os-core:space-type&gt;

  &lt;!-- other document types declarations --&gt;

&lt;/os-core:embedded-space&gt;
</code></pre>

<p>Now we can declare our Document Repository with the next syntax:</p>

<pre><code class="language-java">@SpaceDocumentName(PersonDocument.TYPE_NAME)
public interface PersonDocumentRepository extends XapDocumentRepository&lt;PersonDocument, String&gt; {
}
</code></pre>

<div class="tc-admon-note">
  
  <p>Note that domain class of <code>PersonDocumentRepository</code> is now set to <code>PersonDocument</code> instead of <code>SpaceDocument</code>. Also, type name for <code>PersonDocument</code> is reused in <code>@SpaceDocumentName</code> annotation for the repository.</p>
</div>

<div class="tc-admon-refer">
  
  <p>For more information about the  <code>SpaceDocument</code> refer to <a href="/xap/14.0/dev-java/document-extending.html">Extended Document</a>.</p>
</div>

<p>You can supply your Document Repository with query methods. But be aware that due to dynamic nature of <code>SpaceDocument</code> there is no way for Spring Data to automatically derive query method names into queries. The only possibility to declare a method is to use <code>@Query</code> annotation or load queries from external resources.  Here is an example of Document Repository supplied with search and sorting methods:</p>

<pre><code class="language-java">@SpaceDocumentName(PersonDocument.TYPE_NAME)
public interface PersonDocumentRepository extends XapDocumentRepository&lt;PersonDocument, String&gt; {

    // you can define simple queries
    @Query("name = ?")
    List&lt;PersonDocument&gt; findByName(String name);

    // you can build complex queries
    @Query("name = ? and age = ?")
    List&lt;PersonDocument&gt; findByNameAndAge(String name, Integer age);

    // you can query embedded properties
    @Query("spouse.name = ?")
    List&lt;PersonDocument&gt; findBySpouseName(String name);

    // you can query any properties, even if they are not present in you wrapper
    @Query("customField = ?")
    List&lt;PersonDocument&gt; findByCustomField(String value);

    // you can perform sorting using SQLQuery syntax
    @Query("age = ? order by id asc")
    List&lt;PersonDocument&gt; findByAgeSortedById(Integer age);

}
</code></pre>

<div class="tc-admon-note">
  
  <p>You don't have to declare document properties to use them in queries, which allows dynamically adding and removing the properties.</p>
</div>

<p>Document Repositories do not support <code>Querydsl</code> syntax due to dynamic nature of <code>SpaceDocument</code> properties.</p>

</body>
</html>